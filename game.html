<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game - Lyko Lake Tycoon</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
            background:radial-gradient(ellipse at bottom,#1a3d2e 0%,#0d2818 50%,#06140f 100%);
            color:#e0f2e9;min-height:100vh;
        }
        .hidden{display:none!important}
        nav{
            background:rgba(13,40,24,.85);backdrop-filter:blur(10px);
            padding:20px 40px;display:flex;justify-content:space-between;align-items:center;
            position:sticky;top:0;z-index:1000;
        }
        .logo{font-size:1.8em;font-weight:bold;color:#88d8a3;text-decoration:none}
        .container{max-width:1200px;margin:20px auto;padding:20px;display:flex;gap:20px}
        .map-area{flex:2;background:#000;height:600px;border-radius:10px;position:relative} /* Placeholder map */
        .sidebar{flex:1;background:rgba(13,40,24,.5);padding:20px;border-radius:10px}
        .mission-button{background:#88d8a3;color:#0d2818;padding:10px;margin:10px 0;display:block;width:100%;border:none;border-radius:5px;cursor:pointer}
        .chat-area{background:rgba(255,255,255,.1);padding:10px;border-radius:5px;max-height:200px;overflow-y:auto}
        .tutorial-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:2000}
        .tutorial-content{background:#fff;color:#000;padding:40px;border-radius:20px;max-width:600px;text-align:center}
        .beta-tag{color:#ffcc00}
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, addDoc, collection, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDUBeWvs6kOijqST6FVGirWs2EZ12aAAwU",
            authDomain: "lyko-lake.firebaseapp.com",
            projectId: "lyko-lake",
            storageBucket: "lyko-lake.firebasestorage.app",
            messagingSenderId: "685592614306",
            appId: "1:685592614306:web:b6a8f6f18407f9c0154efb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        onAuthStateChanged(auth, async user => {
            if (!user) return window.location.href = '/auth.html';
            const snap = await getDoc(doc(db, 'users', user.uid));
            currentUser = { ...snap.data(), userId: user.uid };
            document.getElementById('moneyDisplay').textContent = `$${currentUser.money}`;
            if (!currentUser.playedBefore) {
                document.getElementById('tutorialModal').classList.remove('hidden');
            } else {
                loadGame();
            }
        });

        document.getElementById('continueTutorial').addEventListener('click', async () => {
            if (!currentUser.character.hair) { // Check if customized
                if (confirm('Customize character first?')) window.location.href = '/customize.html';
            }
            document.getElementById('tutorialModal').classList.add('hidden');
            await updateDoc(doc(db, 'users', currentUser.userId), { playedBefore: true });
            loadGame();
        });

        async function loadGame() {
            // Placeholder map (canvas)
            const canvas = document.getElementById('gameMap');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(0, 0, canvas.width, canvas.height); // Green map
            ctx.fillStyle = '#0000ff';
            ctx.fillRect(100, 100, 50, 50); // Blue lake

            // Missions (placeholder)
            document.getElementById('deliveryMission').addEventListener('click', async () => {
                await updateDoc(doc(db, 'users', currentUser.userId), { money: currentUser.money + 100 });
                alert('Mission complete! +$100');
                location.reload();
            });

            // Chat (multiplayer placeholder)
            const chatQuery = query(collection(db, 'chat'), orderBy('createdAt', 'desc'), limit(10));
            onSnapshot(chatQuery, snaps => {
                const chat = document.getElementById('chatMessages');
                chat.innerHTML = '';
                snaps.forEach(snap => {
                    chat.innerHTML += `<p>${snap.data().username}: ${snap.data().message}</p>`;
                });
            });

            document.getElementById('sendChat').addEventListener('click', async () => {
                const msg = document.getElementById('chatInput').value;
                if (msg) {
                    await addDoc(collection(db, 'chat'), { username: currentUser.username, message: msg, createdAt: serverTimestamp() });
                    document.getElementById('chatInput').value = '';
                }
            });
        }
    </script>
</head>
<body>
    <nav>
        <a href="/" class="logo">Lyko Lake Tycoon <span class="beta-tag">BETA</span></a>
    </nav>
    <div class="container">
        <div class="map-area">
            <canvas id="gameMap" width="800" height="600"></canvas>
            <p class="beta-tag">Map Placeholder - Coming Soon: Interactive .io Map</p>
        </div>
        <div class="sidebar">
            <h2>Your Stats</h2>
            <p>Money: <span id="moneyDisplay">$0</span></p>
            <h2>Missions (BETA)</h2>
            <button id="deliveryMission" class="mission-button">Delivery Mission (+$100)</button>
            <button class="mission-button">Heist Mission (Coming Soon)</button>
            <h2>Chat (Multiplayer)</h2>
            <div id="chatMessages" class="chat-area"></div>
            <input id="chatInput" type="text" placeholder="Type message...">
            <button id="sendChat">Send</button>
        </div>
    </div>
    
    <div id="tutorialModal" class="tutorial-modal hidden">
        <div class="tutorial-content">
            <h2>Welcome to Lyko Lake Tycoon!</h2>
            <p>You step out of the airport as a new immigrant in Lyko City. Your goal: Complete missions to earn money, buy properties, and build your empire. Team up with friends online.</p>
            <p>Tutorial: Click missions in the sidebar to earn money. Chat with others. BETA - More coming soon!</p>
            <button id="continueTutorial">Continue</button>
        </div>
    </div>
</body>
</html>
