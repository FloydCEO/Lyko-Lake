<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Lyko Lake</title>
<style>
:root{
  --ceo:#ff3b30;
  --admin:#34c759;
  --bg:#0a4d4d;
  --accent:#22c5a4;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
body{background:linear-gradient(135deg,var(--bg) 0%,#1a6b6b 50%,#0f3d3d 100%);color:#fff;min-height:100vh;padding:30px;}
nav{background:rgba(10,77,77,.95);backdrop-filter:blur(10px);padding:20px 40px;display:flex;justify-content:space-between;align-items:center;
    border-radius:15px;margin-bottom:30px;box-shadow:0 4px 20px rgba(0,0,0,.3);border:2px solid rgba(34,197,164,.3);}
.logo{font-size:1.8em;font-weight:bold;color:var(--accent);text-decoration:none;display:flex;align-items:center;gap:10px;transition:transform .3s ease;}
.logo:hover{transform:scale(1.05);}
h1{font-size:2.5em;margin:20px 0 10px;background:linear-gradient(135deg,var(--accent) 0%,#4dd4b8 100%);-webkit-background-clip:text;
   -webkit-text-fill-color:transparent;background-clip:text;}
.user-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-top:20px;}
.user-card{background:rgba(255,255,255,.05);border:2px solid rgba(34,197,164,.3);border-radius:15px;padding:20px;
          backdrop-filter:blur(10px);transition:all .3s ease;position:relative;}
.user-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(34,197,164,.4);border-color:var(--accent);}
.user-header{display:flex;align-items:center;gap:15px;margin-bottom:15px;}
.user-avatar{width:60px;height:60px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,var(--accent) 0%,#0a8f7a 100%);}
.user-avatar img{width:100%;height:100%;object-fit:cover;}
.user-info{flex:1;}
.user-name{font-size:1.3em;font-weight:bold;color:var(--accent);display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.user-username{color:rgba(255,255,255,.6);font-size:.9em;margin-top:4px;}
.user-uid{color:rgba(255,255,255,.5);font-size:.85em;margin-top:2px;}
.rank{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.75em;font-weight:600;position:relative;cursor:help;}
.rank.CEO{background:var(--ceo);box-shadow:0 0 10px var(--ceo);animation:vibe .8s infinite alternate;}
.rank.Admin{background:var(--admin);}
.rank:hover .rank-tooltip{opacity:1;visibility:visible;}
.rank-tooltip{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,.95);color:#fff;
             padding:8px 12px;border-radius:8px;font-size:.9em;white-space:nowrap;opacity:0;visibility:hidden;transition:opacity .2s;
             pointer-events:none;border:2px solid var(--accent);z-index:1000;}
.user-actions{display:flex;gap:8px;flex-wrap:wrap;}
.action-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);color:#fff;padding:8px 16px;border-radius:8px;
           cursor:pointer;font-size:.9em;transition:all .3s ease;font-weight:600;}
.action-btn:hover:not(:disabled){background:rgba(255,255,255,.2);transform:translateY(-2px);}
.action-btn:disabled{opacity:.4;cursor:not-allowed;}
.action-btn.ban{border-color:rgba(255,59,48,.5);}
.action-btn.ban:hover:not(:disabled){background:rgba(255,59,48,.2);color:#ff3b30;}
.action-btn.mute{border-color:rgba(255,204,0,.5);}
.action-btn.mute:hover:not(:disabled){background:rgba(255,204,0,.2);color:#ffcc00;}
.action-btn.rename{border-color:rgba(52,199,89,.5);}
.action-btn.rename:hover:not(:disabled){background:rgba(52,199,89,.2);color:#34c759;}
.action-btn.rank{border-color:rgba(175,82,222,.5);}
.action-btn.rank:hover:not(:disabled){background:rgba(175,82,222,.2);color:#af52de;}
.action-btn.unban{border-color:rgba(52,199,89,.5);}
.action-btn.unban:hover:not(:disabled){background:rgba(52,199,89,.2);color:#34c759;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(5px);}
.modal-content{background:var(--bg);border:2px solid var(--accent);border-radius:20px;padding:30px;width:90%;max-width:500px;
              box-shadow:0 15px 50px rgba(0,0,0,.5);backdrop-filter:blur(10px);}
.modal h3{margin-bottom:20px;font-size:1.8em;color:var(--accent);}
.modal label{display:block;margin:15px 0 8px;color:rgba(255,255,255,.9);font-weight:600;}
.modal input,.modal select,.modal textarea{width:100%;padding:12px;margin:6px 0;border-radius:10px;border:2px solid rgba(34,197,164,.3);
                                          background:rgba(255,255,255,.05);color:#fff;font-size:1em;transition:all .3s ease;}
.modal input:focus,.modal select:focus,.modal textarea:focus{outline:none;border-color:var(--accent);background:rgba(34,197,164,.1);}
.modal textarea{resize:vertical;min-height:80px;font-family:inherit;}
.modal-actions{display:flex;gap:15px;justify-content:flex-end;margin-top:25px;}
.modal-btn{padding:12px 25px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:1em;transition:all .3s ease;}
.modal-btn.cancel{background:rgba(255,255,255,.1);color:rgba(255,255,255,.7);}
.modal-btn.cancel:hover{background:rgba(255,255,255,.2);}
.modal-btn.confirm{background:var(--accent);color:var(--bg);}
.modal-btn.confirm:hover{background:#4dd4b8;transform:translateY(-2px);box-shadow:0 5px 15px rgba(34,197,164,.4);}
.hidden{display:none;}
.temp-options{margin-top:10px;display:flex;gap:10px;align-items:center;}
.temp-options input{flex:1;}
.temp-options select{flex:1;}
.status-badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.75em;font-weight:600;margin-left:10px;}
.status-badge.banned{background:rgba(255,59,48,.3);color:#ff3b30;border:1px solid #ff3b30;}
.status-badge.muted{background:rgba(255,204,0,.3);color:#ffcc00;border:1px solid #ffcc00;}
.loading{text-align:center;padding:100px 20px;font-size:1.5em;color:rgba(255,255,255,.7);}
@keyframes vibe{to{transform:scale(1.05);}}
@media(max-width:768px){
  body{padding:15px;}
  nav{padding:15px;flex-direction:column;gap:15px;}
  .user-grid{grid-template-columns:1fr;}
  .modal-content{padding:20px;}
}
</style>
</head>
<body>
<nav>
  <a href="/" class="logo">ðŸŒŠ Lyko Lake</a>
  <h1>Admin Panel</h1>
</nav>

<div class="loading" id="loading">Loading users...</div>

<div id="userGrid" class="user-grid hidden"></div>

<!-- MODAL -->
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <h3 id="modalTitle">Action</h3>
    <div id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="modalCancel">Cancel</button>
      <button class="modal-btn confirm" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<script type="module">
import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import {getAuth,onAuthStateChanged} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import {getFirestore,collection,getDocs,doc,getDoc,updateDoc,setDoc,deleteDoc,serverTimestamp,deleteField} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const cfg={
  apiKey:"AIzaSyDUBeWvs6kOijqST6FVGirWs2EZ12aAAwU",
  authDomain:"lyko-lake.firebaseapp.com",
  projectId:"lyko-lake",
  storageBucket:"lyko-lake.firebasestorage.app",
  messagingSenderId:"685592614306",
  appId:"1:685592614306:web:b6a8f6f18407f9c0154efb"
};
const app=initializeApp(cfg);
const auth=getAuth(app);
const db=getFirestore(app);

const $=q=>document.querySelector(q);
const modal=$('#modal'),modalTitle=$('#modalTitle'),modalBody=$('#modalBody'),
      modalCancel=$('#modalCancel'),modalConfirm=$('#modalConfirm');
const loading=$('#loading'),userGrid=$('#userGrid');

let currentAction={};
let myRank='Member';
let allUsers=[];
let allBans=[];

/* ----------  HIDE/SHOW MODAL  ---------- */
const hideModal=()=>modal.classList.add('hidden');
const showModal=(title,body)=>{
  modalTitle.textContent=title;
  modalBody.innerHTML=body;
  modal.classList.remove('hidden');
};
modalCancel.onclick=hideModal;
modalConfirm.onclick=()=>{hideModal();currentAction.confirm?.();};

/* ----------  PERMISSION CHECK  ---------- */
onAuthStateChanged(auth,async user=>{
  if(!user){location.href='/auth.html';return;}
  const me=(await getDoc(doc(db,'users',user.uid))).data();
  myRank=me?.rank||'Member';
  if(myRank==='Member'){location.href='/404.html';return;}
  loadUsers();
});

/* ----------  LOAD ALL USERS + BANS  ---------- */
async function loadUsers(){
  try{
    const usersSnap=await getDocs(collection(db,'users'));
    const bansSnap=await getDocs(collection(db,'bans'));
    allBans=[];
    bansSnap.forEach(d=>allBans.push({uid:d.id,...d.data()}));
    allUsers=[];
    usersSnap.forEach(d=>allUsers.push({id:d.id,...d.data()}));
    allUsers.sort((a,b)=>(a.uid||0)-(b.uid||0));
    renderUsers();
  }catch(e){
    console.error(e);
    loading.textContent='Error loading users.';
  }
}

function renderUsers(){
  userGrid.innerHTML='';
  allUsers.forEach(u=>{
    const card=document.createElement('div');
    card.className='user-card';
    const isBanned=allBans.find(b=>b.uid===u.id);
    const isMuted=u.muted||false;
    let statusHTML='';
    if(isBanned)statusHTML='<span class="status-badge banned">BANNED</span>';
    else if(isMuted)statusHTML='<span class="status-badge muted">MUTED</span>';
    let rankHTML='';
    if(u.rank){
      const tooltip=u.rank==='CEO'?'CEO of Lyko Lake':'This Player is an Admin';
      rankHTML=`<span class="rank ${u.rank}">${u.rank}<span class="rank-tooltip">${tooltip}</span></span>`;
    }
    card.innerHTML=`
      <div class="user-header">
        <div class="user-avatar"><img src="${u.avatar||'https://via.placeholder.com/60'}" alt=""></div>
        <div class="user-info">
          <div class="user-name">${u.displayName}${rankHTML}${statusHTML}</div>
          <div class="user-username">@${u.username}</div>
          <div class="user-uid">UID: #${u.uid}</div>
        </div>
      </div>
      <div class="user-actions" data-uid="${u.id}" data-rank="${u.rank||'Member'}"></div>
    `;
    const actions=card.querySelector('.user-actions');
    if(u.rank==='CEO'){
      actions.innerHTML='<i style="color:rgba(255,255,255,.5)">CEO â€“ Immutable</i>';
    }else{
      const canModify=(myRank==='CEO')||(myRank==='Admin'&&u.rank!=='Admin');
      if(isBanned){
        actions.innerHTML=`<button class="action-btn unban" data-action="unban" ${canModify?'':'disabled'}>Unban</button>`;
      }else{
        actions.innerHTML=`
          <button class="action-btn ban" data-action="ban" ${canModify?'':'disabled'}>Ban</button>
          <button class="action-btn mute" data-action="mute" ${canModify?'':'disabled'}>Mute</button>
          <button class="action-btn rename" data-action="rename" ${canModify?'':'disabled'}>Rename</button>
        `;
      }
      if(myRank==='CEO'){
        actions.innerHTML+=`<button class="action-btn rank" data-action="rank">Rank</button>`;
      }
    }
    userGrid.appendChild(card);
  });
  loading.classList.add('hidden');
  userGrid.classList.remove('hidden');
}

/* ----------  ACTION HANDLERS  ---------- */
userGrid.addEventListener('click',async e=>{
  const btn=e.target.closest('button');
  if(!btn)return;
  const uid=btn.closest('.user-actions').dataset.uid;
  const user=allUsers.find(u=>u.id===uid);
  if(!user)return;
  currentAction={uid,user};
  const action=btn.dataset.action;
  if(action==='ban')banUser(user);
  else if(action==='unban')unbanUser(user);
  else if(action==='mute')muteUser(user);
  else if(action==='rename')renameUser(user);
  else if(action==='rank')changeRank(user);
});

/* ---- BAN ---- */
function banUser(u){
  const body=`
    <label>Ban Type</label>
    <select id="banType">
      <option value="perm">Permanent</option>
      <option value="temp">Temporary</option>
    </select>
    <div id="tempOpts" class="temp-options hidden">
      <input id="banVal" type="number" min="1" value="1">
      <select id="banUnit">
        <option value="s">Seconds</option>
        <option value="m">Minutes</option>
        <option value="h">Hours</option>
        <option value="d">Days</option>
        <option value="y">Years</option>
      </select>
    </div>
    <label>Reason (visible to user)</label>
    <textarea id="banReason" placeholder="Enter ban reason..."></textarea>
  `;
  showModal('Ban User',body);
  $('#banType').onchange=e=>{
    $('#tempOpts').classList.toggle('hidden',e.target.value==='perm');
  };
  currentAction.confirm=async()=>{
    const type=$('#banType').value,reason=$('#banReason').value.trim()||'No reason given';
    let until=null;
    if(type==='temp'){
      const n=Number($('#banVal').value),unit=$('#banUnit').value;
      const ms={s:1000,m:60000,h:3600000,d:86400000,y:31536000000}[unit];
      until=new Date(Date.now()+n*ms);
    }
    await setDoc(doc(db,'bans',currentAction.uid),{until,reason,by:auth.currentUser.uid,at:serverTimestamp()});
    alert(`${u.displayName} banned.`);
    loadUsers();
  };
}

/* ---- UNBAN ---- */
function unbanUser(u){
  showModal('Unban User',`<p>Unban <strong>${u.displayName}</strong>?</p>`);
  currentAction.confirm=async()=>{
    await deleteDoc(doc(db,'bans',currentAction.uid));
    alert(`${u.displayName} unbanned.`);
    loadUsers();
  };
}

/* ---- MUTE ---- */
function muteUser(u){
  const body=`<label>Reason (internal)</label><textarea id="muteReason" placeholder="Enter mute reason..."></textarea>`;
  showModal('Mute User',body);
  currentAction.confirm=async()=>{
    await updateDoc(doc(db,'users',currentAction.uid),{muted:true});
    alert(`${u.displayName} muted.`);
    loadUsers();
  };
}

/* ---- RENAME ---- */
function renameUser(u){
  const body=`<label>New Display Name</label><input id="newName" value="${u.displayName}" maxlength="30">`;
  showModal('Rename User',body);
  currentAction.confirm=async()=>{
    const name=$('#newName').value.trim();
    if(!name){alert('Name required');return;}
    await updateDoc(doc(db,'users',currentAction.uid),{displayName:name});
    alert(`${u.displayName} renamed to ${name}.`);
    loadUsers();
  };
}

/* ---- CHANGE RANK ---- */
function changeRank(u){
  const body=`
    <label>Rank</label>
    <select id="rankSel">
      <option value="Member">Member</option>
      <option value="Admin">Admin</option>
      ${myRank==='CEO'?'<option value="CEO">CEO</option>':''}
    </select>
  `;
  showModal('Change Rank',body);
  $('#rankSel').value=u.rank||'Member';
  currentAction.confirm=async()=>{
    const rank=$('#rankSel').value;
    if(rank==='Member')await updateDoc(doc(db,'users',currentAction.uid),{rank:deleteField()});
    else await updateDoc(doc(db,'users',currentAction.uid),{rank});
    alert(`${u.displayName} is now ${rank}.`);
    loadUsers();
  };
}
</script>
</body>
</html>
