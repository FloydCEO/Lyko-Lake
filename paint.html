<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lykos Paint</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Teko:wght@400;500;600&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #1a1a2e;
    --toolbar-bg: #16213e;
    --menubar-bg: #0f3460;
    --accent: #e94560;
    --accent2: #f5a623;
    --panel: #1e2a45;
    --panel-border: #2a3f6e;
    --text: #c8d6f0;
    --text-dim: #6a7fa0;
    --tool-hover: #253558;
    --canvas-bg: #2a2a2a;
    --statusbar: #0d1b2e;
  }

  html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); font-family:'Share Tech Mono',monospace; color:var(--text); user-select:none; }

  #app { display:flex; flex-direction:column; height:100vh; }

  /* TITLE BAR */
  #titlebar {
    height:32px;
    background:linear-gradient(90deg,#0f3460,#1a1a6e,#e94560 140%);
    display:flex; align-items:center;
    padding:0 12px; gap:8px;
    font-family:'Teko',sans-serif; font-size:16px; letter-spacing:3px; color:#fff;
    flex-shrink:0;
  }
  #titlebar .dot { width:10px; height:10px; border-radius:50%; }
  .d1{background:#e94560;} .d2{background:#f5a623;} .d3{background:#2ecc71;}
  #titlebar .logo { margin-left:8px; display:flex; align-items:center; gap:0; }
  #titlebar .logo-lyk { color:#fff; }
  #titlebar .logo-o { color:var(--accent2); }
  #titlebar .logo-s { color:#fff; }
  #titlebar .logo-paint { color:rgba(255,255,255,0.75); margin-left:10px; letter-spacing:4px; }
  #projectNameDisplay {
    margin-left:8px; font-size:13px; letter-spacing:1px;
    color:rgba(255,255,255,0.6); cursor:pointer;
    padding:2px 6px; border-radius:3px;
    transition:background 0.15s;
  }
  #projectNameDisplay:hover { background:rgba(255,255,255,0.1); color:#fff; }
  #projectNameDisplay .ext { color:var(--accent2); }
  .title-spacer { flex:1; }
  #dirtyDot { width:8px; height:8px; border-radius:50%; background:var(--accent2); display:none; margin-left:6px; }
  #dirtyDot.show { display:block; }

  /* MENUBAR */
  #menubar {
    height:28px; background:var(--menubar-bg);
    display:flex; align-items:stretch;
    border-bottom:1px solid var(--panel-border);
    flex-shrink:0; position:relative; z-index:200;
  }
  .menu-btn {
    padding:0 14px; font-family:'Share Tech Mono',monospace; font-size:12px;
    color:var(--text); cursor:pointer; display:flex; align-items:center;
    letter-spacing:1px; transition:background 0.1s; position:relative;
  }
  .menu-btn:hover, .menu-btn.open { background:var(--accent); color:#fff; }
  .dropdown {
    display:none; position:absolute; top:100%; left:0;
    background:#0f2040; border:1px solid var(--accent);
    min-width:210px; z-index:9999;
    box-shadow:4px 4px 0 rgba(0,0,0,0.5);
  }
  .dropdown.show { display:block; }
  .dropdown-item {
    padding:8px 16px; font-size:12px; cursor:pointer;
    color:var(--text); display:flex; align-items:center; gap:10px; letter-spacing:0.5px;
  }
  .dropdown-item:hover { background:var(--accent); color:#fff; }
  .dropdown-item:hover .shortcut { color:rgba(255,255,255,0.6); }
  .shortcut { margin-left:auto; color:var(--text-dim); font-size:10px; }
  .dropdown-sep { height:1px; background:var(--panel-border); margin:4px 0; }

  /* MAIN */
  #main { display:flex; flex:1; overflow:hidden; }

  /* TOOLBAR ‚Äî overflow visible so tooltips show */
  #toolbar {
    width:52px; background:var(--toolbar-bg);
    border-right:1px solid var(--panel-border);
    display:flex; flex-direction:column; align-items:center;
    padding:8px 4px; gap:2px;
    overflow:visible; /* KEY FIX: was overflow-y:auto which clipped tooltips */
    flex-shrink:0;
    position:relative; z-index:150;
  }
  .tool-group { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:100%; margin-bottom:4px; }
  .tool-sep { width:80%; height:1px; background:var(--panel-border); margin:4px auto; }
  .tool-btn {
    width:22px; height:22px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; border-radius:3px; font-size:13px;
    transition:background 0.1s; background:transparent; color:var(--text);
    position:relative;
  }
  .tool-btn:hover { background:var(--tool-hover); }
  .tool-btn.active { background:var(--accent); color:#fff; }
  .tool-btn svg { width:14px; height:14px; pointer-events:none; }

  /* TOOLTIP ‚Äî fixed positioning so it's never clipped */
  .tool-btn .tip {
    display:none;
    position:fixed;
    background:#0a0f1e;
    color:#fff;
    font-size:10px;
    padding:4px 8px;
    white-space:nowrap;
    pointer-events:none;
    z-index:99999;
    border:1px solid var(--accent);
    border-radius:2px;
    letter-spacing:0.5px;
    box-shadow:2px 2px 6px rgba(0,0,0,0.5);
  }
  .tool-btn:hover .tip { display:block; }

  /* RIGHT PANEL */
  #rightpanel {
    width:185px; background:var(--toolbar-bg);
    border-left:1px solid var(--panel-border);
    display:flex; flex-direction:column;
    padding:10px 8px; gap:12px;
    overflow-y:auto; flex-shrink:0; font-size:11px;
  }
  #rightpanel::-webkit-scrollbar { width:3px; }
  #rightpanel::-webkit-scrollbar-thumb { background:var(--panel-border); }

  .panel-section h4 {
    font-family:'Teko',sans-serif; font-size:13px;
    letter-spacing:2px; color:var(--accent2);
    margin-bottom:6px; text-transform:uppercase;
    border-bottom:1px solid var(--panel-border); padding-bottom:4px;
  }
  .slider-row { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
  .slider-row label { flex:0 0 58px; color:var(--text-dim); font-size:10px; }
  .slider-row input[type=range] {
    flex:1; -webkit-appearance:none; height:3px;
    background:var(--panel-border); outline:none; border-radius:2px;
  }
  .slider-row input[type=range]::-webkit-slider-thumb {
    -webkit-appearance:none; width:10px; height:10px;
    border-radius:50%; background:var(--accent); cursor:pointer;
  }
  .slider-row .val { flex:0 0 26px; text-align:right; color:var(--text); font-size:10px; }

  #currentColors { display:flex; gap:6px; margin-bottom:8px; align-items:center; }
  .cswatch { width:28px; height:28px; border:2px solid var(--panel-border); cursor:pointer; }
  #bgSwatch { width:20px; height:20px; border:2px solid var(--panel-border); cursor:pointer; margin-left:-10px; margin-top:14px; }
  .color-info { font-size:10px; color:var(--text-dim); line-height:1.5; margin-left:6px; }
  .color-pickers { display:flex; gap:6px; margin-top:8px; }
  .color-pickers label { font-size:9px; color:var(--text-dim); display:flex; flex-direction:column; align-items:center; gap:2px; }
  .color-pickers input[type=color] { width:28px; height:20px; padding:0; border:1px solid var(--panel-border); background:transparent; cursor:pointer; }

  #palette { display:grid; grid-template-columns:repeat(6,1fr); gap:3px; margin-top:8px; }
  .pal-color { width:100%; aspect-ratio:1; cursor:pointer; border:1px solid transparent; transition:transform 0.1s,border-color 0.1s; }
  .pal-color:hover { transform:scale(1.2); border-color:#fff; z-index:2; position:relative; }

  /* Layers */
  #layerList { display:flex; flex-direction:column; gap:3px; }
  .layer-item {
    padding:5px 6px; background:var(--panel);
    border:1px solid var(--panel-border); border-radius:3px;
    font-size:10px; cursor:pointer;
    display:flex; align-items:center; gap:6px;
  }
  .layer-item.active { border-color:var(--accent); background:#1e2d4a; }
  .layer-item .eye { cursor:pointer; opacity:0.6; font-size:11px; }
  .layer-item .eye:hover { opacity:1; }
  .layer-item .lname { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .layer-actions { display:flex; gap:4px; margin-top:4px; }
  .layer-actions button {
    flex:1; background:var(--panel); border:1px solid var(--panel-border);
    color:var(--text); font-family:'Share Tech Mono',monospace; font-size:9px;
    padding:4px; cursor:pointer; border-radius:2px; transition:background 0.1s;
  }
  .layer-actions button:hover { background:var(--accent); border-color:var(--accent); color:#fff; }

  /* CANVAS AREA */
  #canvasArea {
    flex:1; background:var(--canvas-bg);
    background-image:
      linear-gradient(45deg,#333 25%,transparent 25%),
      linear-gradient(-45deg,#333 25%,transparent 25%),
      linear-gradient(45deg,transparent 75%,#333 75%),
      linear-gradient(-45deg,transparent 75%,#333 75%);
    background-size:16px 16px;
    background-position:0 0,0 8px,8px -8px,-8px 0px;
    overflow:auto; position:relative;
  }
  #canvasArea::-webkit-scrollbar { width:8px; height:8px; }
  #canvasArea::-webkit-scrollbar-track { background:var(--bg); }
  #canvasArea::-webkit-scrollbar-thumb { background:var(--panel-border); }
  #canvasWrapper { position:relative; margin:20px; box-shadow:0 0 0 1px rgba(255,255,255,0.1),0 8px 32px rgba(0,0,0,0.6); display:inline-block; }
  canvas { display:block; }
  #drawCanvas { position:absolute; top:0; left:0; cursor:crosshair; }

  /* STATUS BAR */
  #statusbar {
    height:22px; background:var(--statusbar);
    border-top:1px solid var(--panel-border);
    display:flex; align-items:center; padding:0 12px; gap:20px;
    font-size:10px; color:var(--text-dim); flex-shrink:0;
  }
  #statusbar span b { color:var(--text); }

  /* MODALS */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:10000; align-items:center; justify-content:center; }
  .modal-overlay.show { display:flex; }
  .modal {
    background:#0f2040; border:1px solid var(--accent);
    padding:24px; min-width:320px;
    box-shadow:6px 6px 0 rgba(0,0,0,0.5);
  }
  .modal h3 { font-family:'Teko',sans-serif; font-size:20px; letter-spacing:2px; color:var(--accent2); margin-bottom:18px; text-transform:uppercase; }
  .modal label { font-size:11px; color:var(--text-dim); display:block; margin-bottom:4px; }
  .modal input[type=text], .modal input[type=number], .modal select {
    width:100%; padding:7px 8px;
    background:var(--panel); border:1px solid var(--panel-border);
    color:var(--text); font-family:'Share Tech Mono',monospace;
    font-size:12px; margin-bottom:14px;
  }
  .modal input:focus, .modal select:focus { outline:none; border-color:var(--accent); }
  .modal-buttons { display:flex; gap:8px; justify-content:flex-end; margin-top:4px; }
  .modal-buttons button {
    padding:7px 18px; font-family:'Share Tech Mono',monospace; font-size:11px;
    cursor:pointer; border-radius:2px; border:1px solid; transition:background 0.1s;
  }
  .btn-primary { background:var(--accent); border-color:var(--accent); color:#fff; }
  .btn-primary:hover { background:#c73050; }
  .btn-cancel { background:transparent; border-color:var(--panel-border); color:var(--text); }
  .btn-cancel:hover { background:var(--panel); }

  /* Toast */
  #toast {
    position:fixed; bottom:40px; left:50%; transform:translateX(-50%);
    background:#0f2040; border:1px solid var(--accent2);
    color:var(--accent2); font-size:11px; padding:8px 16px;
    z-index:99999; opacity:0; transition:opacity 0.3s;
    pointer-events:none; letter-spacing:1px;
  }
  #toast.show { opacity:1; }
</style>
</head>
<body>
<div id="app">

  <!-- Title bar -->
  <div id="titlebar">
    <div class="dot d1"></div><div class="dot d2"></div><div class="dot d3"></div>
    <div class="logo"><span class="logo-lyk">LYK</span><span class="logo-o">O</span><span class="logo-s">S</span><span class="logo-paint">PAINT</span></div>
    <div id="projectNameDisplay" onclick="renameProject()" title="Click to rename project">
      <span id="pnameSpan">untitled</span><span class="ext">.lyko</span>
    </div>
    <div id="dirtyDot"></div>
    <div class="title-spacer"></div>
  </div>

  <!-- Menu bar -->
  <div id="menubar">
    <div class="menu-btn" id="mFile" onclick="toggleMenu('mFile','ddFile')">FILE</div>
    <div class="menu-btn" id="mEdit" onclick="toggleMenu('mEdit','ddEdit')">EDIT</div>
    <div class="menu-btn" id="mView" onclick="toggleMenu('mView','ddView')">VIEW</div>
    <div class="menu-btn" id="mImage" onclick="toggleMenu('mImage','ddImage')">IMAGE</div>
    <div class="menu-btn" id="mHelp" onclick="toggleMenu('mHelp','ddHelp')">HELP</div>

    <div class="dropdown" id="ddFile" style="left:0">
      <div class="dropdown-item" onclick="newCanvas()">‚¨ú New Project <span class="shortcut">Ctrl+N</span></div>
      <div class="dropdown-item" onclick="openLyko()">üìÇ Open .lyko Project <span class="shortcut">Ctrl+O</span></div>
      <div class="dropdown-item" onclick="openImage()">üñº Import Image</div>
      <div class="dropdown-sep"></div>
      <div class="dropdown-item" onclick="saveLyko()">üíæ Save Project (.lyko) <span class="shortcut">Ctrl+S</span></div>
      <div class="dropdown-sep"></div>
      <div class="dropdown-item" onclick="exportCanvas('png')">‚¨á Export as PNG</div>
      <div class="dropdown-item" onclick="exportCanvas('jpg')">‚¨á Export as JPG</div>
      <div class="dropdown-item" onclick="exportCanvas('webp')">‚¨á Export as WebP</div>
    </div>
    <div class="dropdown" id="ddEdit" style="left:52px">
      <div class="dropdown-item" onclick="undo()">‚Ü© Undo <span class="shortcut">Ctrl+Z</span></div>
      <div class="dropdown-item" onclick="redo()">‚Ü™ Redo <span class="shortcut">Ctrl+Y</span></div>
      <div class="dropdown-sep"></div>
      <div class="dropdown-item" onclick="clearCanvas()">üóë Clear Layer</div>
      <div class="dropdown-item" onclick="renameProject()">‚úè Rename Project</div>
    </div>
    <div class="dropdown" id="ddView" style="left:104px">
      <div class="dropdown-item" onclick="zoom(1.25)">üîç Zoom In <span class="shortcut">Ctrl++</span></div>
      <div class="dropdown-item" onclick="zoom(0.8)">üîç Zoom Out <span class="shortcut">Ctrl+-</span></div>
      <div class="dropdown-item" onclick="zoom(null,1)">‚¨õ Reset Zoom <span class="shortcut">Ctrl+0</span></div>
      <div class="dropdown-sep"></div>
      <div class="dropdown-item" onclick="toggleGrid()">‚äû Toggle Grid</div>
    </div>
    <div class="dropdown" id="ddImage" style="left:156px">
      <div class="dropdown-item" onclick="resizeModal()">‚Üî Resize Canvas</div>
      <div class="dropdown-item" onclick="flipH()">‚áÑ Flip Horizontal</div>
      <div class="dropdown-item" onclick="flipV()">‚áÖ Flip Vertical</div>
      <div class="dropdown-item" onclick="rotate90()">‚Üª Rotate 90¬∞</div>
      <div class="dropdown-sep"></div>
      <div class="dropdown-item" onclick="invertColors()">‚óë Invert Colors</div>
      <div class="dropdown-item" onclick="grayscale()">‚óê Grayscale</div>
    </div>
    <div class="dropdown" id="ddHelp" style="left:210px">
      <div class="dropdown-item" onclick="showAbout()">‚Ñπ About Lykos Paint</div>
    </div>
  </div>

  <!-- Main -->
  <div id="main">

    <!-- Left Toolbar -->
    <div id="toolbar">
      <div class="tool-group">
        <div class="tool-btn active" data-tool="pencil" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
          <span class="tip">Pencil (P)</span>
        </div>
        <div class="tool-btn" data-tool="brush" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.06 11.9l8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1 1 2.48 1.02 3.5 1.02 2.2 0 3-1.8 3-3.02 0-1.67-1.33-3.04-1.5-3.04z"/></svg>
          <span class="tip">Brush (B)</span>
        </div>
        <div class="tool-btn" data-tool="eraser" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l10-10 7 7-3.5 3.5"/><line x1="6" y1="11" x2="14" y2="19"/></svg>
          <span class="tip">Eraser (E)</span>
        </div>
        <div class="tool-btn" data-tool="fill" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 11l-8-8-8.5 8.5a5.5 5.5 0 0 0 7.78 7.78L19 11z"/><circle cx="20" cy="14" r="2" fill="currentColor"/></svg>
          <span class="tip">Fill (F)</span>
        </div>
        <div class="tool-btn" data-tool="eyedropper" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 22l1-1h3l9-9"/><path d="M3 21v-3l9-9"/><path d="m15 6 3.4-3.4a2.1 2.1 0 1 1 3 3L18 9l.4.4a2.1 2.1 0 1 1-3 3l-3.8-3.8"/></svg>
          <span class="tip">Eyedropper (I)</span>
        </div>
        <div class="tool-btn" data-tool="select" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="10" height="10" stroke-dasharray="3 2"/></svg>
          <span class="tip">Select</span>
        </div>
        <div class="tool-btn" data-tool="line" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="19" x2="19" y2="5"/></svg>
          <span class="tip">Line (L)</span>
        </div>
        <div class="tool-btn" data-tool="rect" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14"/></svg>
          <span class="tip">Rectangle (R)</span>
        </div>
        <div class="tool-btn" data-tool="ellipse" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="12" rx="10" ry="7"/></svg>
          <span class="tip">Ellipse (O)</span>
        </div>
        <div class="tool-btn" data-tool="text" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
          <span class="tip">Text (T)</span>
        </div>
        <div class="tool-btn" data-tool="spray" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="9" r="1"/><circle cx="12" cy="7" r="1"/><circle cx="15" cy="9" r="1"/><circle cx="10" cy="12" r="1"/><circle cx="14" cy="12" r="1"/><path d="M5 20h14v-1H5v1z" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M9 16v3M12 15v4M15 16v3" stroke="currentColor" stroke-width="1.5"/></svg>
          <span class="tip">Spray (S)</span>
        </div>
        <div class="tool-btn" data-tool="move" onclick="setTool(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
          <span class="tip">Move</span>
        </div>
      </div>
      <div class="tool-sep"></div>
      <div class="tool-group">
        <div class="tool-btn" id="strokeOnlyBtn" onclick="setFilled(false)" title="">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18"/></svg>
          <span class="tip">Stroke Only</span>
        </div>
        <div class="tool-btn" id="filledBtn" onclick="setFilled(true)">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" fill="currentColor"/></svg>
          <span class="tip">Filled Shape</span>
        </div>
      </div>
    </div>

    <!-- Canvas Area -->
    <div id="canvasArea" onclick="closeAllMenus()">
      <div id="canvasWrapper">
        <canvas id="baseCanvas"></canvas>
        <canvas id="drawCanvas"></canvas>
      </div>
    </div>

    <!-- Right Panel -->
    <div id="rightpanel">

      <div class="panel-section">
        <h4>Tool Settings</h4>
        <div class="slider-row">
          <label>Size</label>
          <input type="range" id="sSize" min="1" max="100" value="8" oninput="updateSize(this)">
          <span class="val" id="vSize">8</span>
        </div>
        <div class="slider-row">
          <label>Opacity</label>
          <input type="range" id="sOpacity" min="1" max="100" value="100" oninput="updateOpacity(this)">
          <span class="val" id="vOpacity">100</span>
        </div>
        <div class="slider-row">
          <label>Hardness</label>
          <input type="range" id="sHardness" min="0" max="100" value="90" oninput="updateHardness(this)">
          <span class="val" id="vHardness">90</span>
        </div>
        <div class="slider-row">
          <label>Spacing</label>
          <input type="range" id="sSpacing" min="1" max="50" value="3" oninput="updateSpacing(this)">
          <span class="val" id="vSpacing">3</span>
        </div>
      </div>

      <div class="panel-section">
        <h4>Color</h4>
        <div id="currentColors">
          <div style="position:relative;width:44px;height:44px;flex-shrink:0;">
            <div class="cswatch" id="fgSwatch" style="background:#000000;position:absolute;top:0;left:0;z-index:2;width:28px;height:28px;" onclick="document.getElementById('fgPicker').click()" title="Foreground color"></div>
            <div class="cswatch" id="bgSwatch2" style="background:#ffffff;position:absolute;bottom:0;right:0;z-index:1;width:22px;height:22px;" onclick="document.getElementById('bgPicker').click()" title="Background color (right-click)"></div>
          </div>
          <div class="color-info">
            FG: <span id="fgHex">#000000</span><br>
            BG: <span id="bgHex">#ffffff</span>
          </div>
        </div>
        <div class="color-pickers">
          <label>FG <input type="color" id="fgPicker" value="#000000" oninput="setFgColor(this.value)"></label>
          <label>BG <input type="color" id="bgPicker" value="#ffffff" oninput="setBgColor(this.value)"></label>
        </div>
        <div id="palette"></div>
      </div>

      <div class="panel-section">
        <h4>Layers</h4>
        <div id="layerList"></div>
        <div class="layer-actions">
          <button onclick="addLayer()">+ Add</button>
          <button onclick="deleteLayer()">- Del</button>
          <button onclick="mergeDown()">‚Üì Merge</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Status bar -->
  <div id="statusbar">
    <span>Tool: <b id="stTool">Pencil</b></span>
    <span>Pos: <b id="stPos">0, 0</b></span>
    <span>Size: <b id="stSize">800 √ó 600</b></span>
    <span>Zoom: <b id="stZoom">100%</b></span>
    <span>Layer: <b id="stLayer">Background</b></span>
  </div>

</div>

<!-- MODALS -->
<div class="modal-overlay" id="newModal">
  <div class="modal">
    <h3>New Project</h3>
    <label>Project Name</label>
    <input type="text" id="newName" value="untitled">
    <label>Width (px)</label>
    <input type="number" id="newW" value="800">
    <label>Height (px)</label>
    <input type="number" id="newH" value="600">
    <label>Background</label>
    <select id="newBg">
      <option value="white">White</option>
      <option value="black">Black</option>
      <option value="transparent">Transparent</option>
    </select>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal('newModal')">Cancel</button>
      <button class="btn-primary" onclick="confirmNew()">Create</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="resizeModalEl">
  <div class="modal">
    <h3>Resize Canvas</h3>
    <label>Width (px)</label>
    <input type="number" id="resW" value="800">
    <label>Height (px)</label>
    <input type="number" id="resH" value="600">
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal('resizeModalEl')">Cancel</button>
      <button class="btn-primary" onclick="confirmResize()">Resize</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="renameModal">
  <div class="modal">
    <h3>Rename Project</h3>
    <label>Project Name</label>
    <input type="text" id="renameInput" value="untitled">
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal('renameModal')">Cancel</button>
      <button class="btn-primary" onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<!-- Hidden inputs -->
<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="loadImage(event)">
<input type="file" id="lykoInput" accept=".lyko" style="display:none" onchange="loadLyko(event)">

<!-- Toast -->
<div id="toast"></div>

<script>
// ================================================================
// STATE
// ================================================================
let tool = 'pencil';
let brushSize = 8;
let opacity = 1;
let hardness = 0.9;
let spacing = 3;
let fgColor = '#000000';
let bgColor = '#ffffff';
let filled = false;
let gridVisible = false;
let currentZoom = 1;
let projectName = 'untitled';
let isDirty = false;

let isDrawing = false;
let lastX = 0, lastY = 0;
let startX = 0, startY = 0;

let undoStack = [];
let redoStack = [];

let layers = [];
let activeLayerIdx = 0;

let baseCanvas, drawCanvas, baseCtx, drawCtx;

// ================================================================
// INIT
// ================================================================
window.addEventListener('DOMContentLoaded', () => {
  baseCanvas = document.getElementById('baseCanvas');
  drawCanvas = document.getElementById('drawCanvas');
  baseCtx = baseCanvas.getContext('2d');
  drawCtx = drawCanvas.getContext('2d');

  initCanvas(800, 600, 'white');
  buildPalette();

  drawCanvas.addEventListener('mousedown', onMouseDown);
  drawCanvas.addEventListener('mousemove', onMouseMove);
  drawCanvas.addEventListener('mouseup', onMouseUp);
  drawCanvas.addEventListener('mouseleave', onMouseUp);
  drawCanvas.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', onKey);
  document.addEventListener('click', e => { if (!e.target.closest('#menubar')) closeAllMenus(); });

  // Tooltip positioning via fixed coords
  document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.addEventListener('mouseenter', (e) => {
      const tip = btn.querySelector('.tip');
      if (!tip) return;
      const rect = btn.getBoundingClientRect();
      tip.style.top = (rect.top + rect.height/2 - 10) + 'px';
      tip.style.left = (rect.right + 8) + 'px';
    });
  });
});

function initCanvas(w, h, bg, name) {
  if (name) projectName = name;
  baseCanvas.width = w; baseCanvas.height = h;
  drawCanvas.width = w; drawCanvas.height = h;

  layers = [{ name: 'Background', canvas: document.createElement('canvas'), visible: true }];
  layers[0].canvas.width = w; layers[0].canvas.height = h;
  const lctx = layers[0].canvas.getContext('2d');
  if (bg === 'white') { lctx.fillStyle = '#ffffff'; lctx.fillRect(0,0,w,h); }
  else if (bg === 'black') { lctx.fillStyle = '#000000'; lctx.fillRect(0,0,w,h); }
  activeLayerIdx = 0;

  compositeAll(); updateLayerUI();
  document.getElementById('stSize').textContent = `${w} √ó ${h}`;
  document.getElementById('resW').value = w;
  document.getElementById('resH').value = h;
  undoStack = []; redoStack = [];
  setDirty(false);
  updateTitleDisplay();
}

function updateTitleDisplay() {
  document.getElementById('pnameSpan').textContent = projectName;
  document.title = `${projectName}.lyko ‚Äî Lykos Paint`;
}

function setDirty(val) {
  isDirty = val;
  document.getElementById('dirtyDot').classList.toggle('show', val);
}

// ================================================================
// LAYERS
// ================================================================
function compositeAll() {
  baseCtx.clearRect(0, 0, baseCanvas.width, baseCanvas.height);
  layers.forEach(l => { if (l.visible) baseCtx.drawImage(l.canvas, 0, 0); });
}
function activeLayerCtx() { return layers[activeLayerIdx].canvas.getContext('2d'); }

function addLayer() {
  const c = document.createElement('canvas');
  c.width = baseCanvas.width; c.height = baseCanvas.height;
  layers.splice(activeLayerIdx+1, 0, { name: `Layer ${layers.length}`, canvas: c, visible: true });
  activeLayerIdx++;
  compositeAll(); updateLayerUI(); setDirty(true);
}
function deleteLayer() {
  if (layers.length <= 1) return;
  layers.splice(activeLayerIdx, 1);
  activeLayerIdx = Math.min(activeLayerIdx, layers.length-1);
  compositeAll(); updateLayerUI(); setDirty(true);
}
function mergeDown() {
  if (activeLayerIdx === 0) return;
  const above = layers[activeLayerIdx];
  const below = layers[activeLayerIdx-1];
  below.canvas.getContext('2d').drawImage(above.canvas, 0, 0);
  layers.splice(activeLayerIdx, 1);
  activeLayerIdx--;
  compositeAll(); updateLayerUI(); setDirty(true);
}
function toggleLayerVis(i) {
  layers[i].visible = !layers[i].visible;
  compositeAll(); updateLayerUI();
}
function updateLayerUI() {
  const list = document.getElementById('layerList');
  list.innerHTML = '';
  [...layers].reverse().forEach((l, ri) => {
    const i = layers.length - 1 - ri;
    const div = document.createElement('div');
    div.className = 'layer-item' + (i === activeLayerIdx ? ' active' : '');
    div.innerHTML = `<span class="eye" onclick="toggleLayerVis(${i}); event.stopPropagation();">${l.visible ? 'üëÅ' : 'üö´'}</span><span class="lname">${l.name}</span>`;
    div.onclick = () => { activeLayerIdx = i; updateLayerUI(); document.getElementById('stLayer').textContent = layers[i].name; };
    list.appendChild(div);
  });
  document.getElementById('stLayer').textContent = layers[activeLayerIdx]?.name || '';
}

// ================================================================
// UNDO / REDO
// ================================================================
function cloneLayers(src) {
  return src.map(l => {
    const c = document.createElement('canvas');
    c.width = l.canvas.width; c.height = l.canvas.height;
    c.getContext('2d').drawImage(l.canvas, 0, 0);
    return { name: l.name, canvas: c, visible: l.visible };
  });
}
function saveState() {
  undoStack.push({ layers: cloneLayers(layers), activeLayerIdx });
  if (undoStack.length > 40) undoStack.shift();
  redoStack = [];
  setDirty(true);
}
function undo() {
  if (!undoStack.length) return;
  redoStack.push({ layers: cloneLayers(layers), activeLayerIdx });
  const s = undoStack.pop();
  layers = cloneLayers(s.layers); activeLayerIdx = s.activeLayerIdx;
  compositeAll(); updateLayerUI();
}
function redo() {
  if (!redoStack.length) return;
  undoStack.push({ layers: cloneLayers(layers), activeLayerIdx });
  const s = redoStack.pop();
  layers = cloneLayers(s.layers); activeLayerIdx = s.activeLayerIdx;
  compositeAll(); updateLayerUI();
}

// ================================================================
// DRAWING
// ================================================================
function getPos(e) {
  const rect = drawCanvas.getBoundingClientRect();
  return [(e.clientX - rect.left) / currentZoom, (e.clientY - rect.top) / currentZoom];
}
function onMouseDown(e) {
  const [x,y] = getPos(e);
  isDrawing = true; lastX = x; lastY = y; startX = x; startY = y;
  saveState();
  const ctx = activeLayerCtx();
  ctx.globalAlpha = opacity;
  if (tool === 'eyedropper') { pickColor(x,y,e.button===2); isDrawing=false; return; }
  if (tool === 'fill') { floodFill(Math.round(x),Math.round(y),e.button===2?bgColor:fgColor); compositeAll(); isDrawing=false; return; }
  if (tool === 'text') { placeText(x,y); isDrawing=false; return; }
  if (['pencil','brush','eraser','spray'].includes(tool)) { drawDot(ctx,x,y,e.button===2); compositeAll(); }
}
function onMouseMove(e) {
  const [x,y] = getPos(e);
  document.getElementById('stPos').textContent = `${Math.round(x)}, ${Math.round(y)}`;
  if (!isDrawing) return;
  const ctx = activeLayerCtx();
  ctx.globalAlpha = opacity;
  if (['pencil','brush','eraser','spray'].includes(tool)) {
    drawStroke(ctx,lastX,lastY,x,y,e.button===2); compositeAll();
  } else if (['line','rect','ellipse'].includes(tool)) {
    drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
    drawCtx.globalAlpha = opacity;
    drawShape(drawCtx,startX,startY,x,y);
  }
  lastX=x; lastY=y;
}
function onMouseUp(e) {
  if (!isDrawing) return;
  isDrawing = false;
  const [x,y] = getPos(e);
  if (['line','rect','ellipse'].includes(tool)) {
    drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
    const ctx = activeLayerCtx();
    ctx.globalAlpha = opacity;
    drawShape(ctx,startX,startY,x,y);
    compositeAll();
  }
}
function drawDot(ctx, x, y, rightBtn) {
  const color = rightBtn ? bgColor : fgColor;
  if (tool==='eraser') {
    ctx.save(); ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,brushSize/2,0,Math.PI*2);
    ctx.fillStyle='rgba(0,0,0,1)'; ctx.fill(); ctx.restore();
  } else if (tool==='spray') {
    sprayDot(ctx,x,y,color);
  } else {
    ctx.beginPath();
    const g = ctx.createRadialGradient(x,y,0,x,y,brushSize/2);
    g.addColorStop(hardness, hexToRgba(color,1));
    g.addColorStop(1, hexToRgba(color,0));
    ctx.fillStyle=g; ctx.arc(x,y,brushSize/2,0,Math.PI*2); ctx.fill();
  }
}
function drawStroke(ctx,x1,y1,x2,y2,rightBtn) {
  const dist = Math.hypot(x2-x1,y2-y1);
  const steps = Math.max(1,Math.floor(dist/spacing));
  for (let i=0;i<=steps;i++) {
    const t=i/steps;
    drawDot(ctx,x1+(x2-x1)*t,y1+(y2-y1)*t,rightBtn);
  }
}
function sprayDot(ctx,x,y,color) {
  const n = Math.floor(brushSize*1.5);
  for (let i=0;i<n;i++) {
    const a=Math.random()*Math.PI*2, r=Math.random()*brushSize;
    ctx.fillStyle=hexToRgba(color,Math.random()*0.6+0.2);
    ctx.fillRect(x+Math.cos(a)*r,y+Math.sin(a)*r,1,1);
  }
}
function drawShape(ctx,x1,y1,x2,y2) {
  ctx.strokeStyle=fgColor; ctx.fillStyle=bgColor; ctx.lineWidth=brushSize;
  ctx.beginPath();
  if (tool==='line') { ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
  else if (tool==='rect') { if (filled) ctx.fillRect(x1,y1,x2-x1,y2-y1); ctx.strokeRect(x1,y1,x2-x1,y2-y1); }
  else if (tool==='ellipse') {
    const rx=Math.abs(x2-x1)/2,ry=Math.abs(y2-y1)/2,cx=(x1+x2)/2,cy=(y1+y2)/2;
    ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
    if (filled) ctx.fill(); ctx.stroke();
  }
}
function pickColor(x,y,toBg) {
  const d = baseCtx.getImageData(Math.round(x),Math.round(y),1,1).data;
  const hex = rgbToHex(d[0],d[1],d[2]);
  if (toBg) setBgColor(hex); else setFgColor(hex);
}
function floodFill(sx,sy,fillHex) {
  const ctx = activeLayerCtx();
  const cv = layers[activeLayerIdx].canvas;
  const id = ctx.getImageData(0,0,cv.width,cv.height);
  const d = id.data;
  const idx=(sy*cv.width+sx)*4;
  const [tr,tg,tb,ta]=[d[idx],d[idx+1],d[idx+2],d[idx+3]];
  const fc=hexToRgbArr(fillHex);
  if (tr===fc[0]&&tg===fc[1]&&tb===fc[2]) return;
  const w=cv.width,h=cv.height;
  const vis=new Uint8Array(w*h);
  const stack=[[sx,sy]];
  const match=i=>Math.abs(d[i]-tr)<30&&Math.abs(d[i+1]-tg)<30&&Math.abs(d[i+2]-tb)<30&&Math.abs(d[i+3]-ta)<30;
  while (stack.length) {
    const [x,y]=stack.pop();
    if (x<0||y<0||x>=w||y>=h) continue;
    const i=(y*w+x)*4;
    if (vis[y*w+x]||!match(i)) continue;
    vis[y*w+x]=1;
    d[i]=fc[0];d[i+1]=fc[1];d[i+2]=fc[2];d[i+3]=255;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
  ctx.putImageData(id,0,0);
}
function placeText(x,y) {
  const txt=prompt('Enter text:');
  if (!txt) return;
  const ctx=activeLayerCtx();
  ctx.font=`${brushSize*3}px Share Tech Mono,monospace`;
  ctx.fillStyle=fgColor; ctx.globalAlpha=opacity;
  ctx.fillText(txt,x,y); compositeAll();
}

// ================================================================
// TOOLS
// ================================================================
function setTool(el) {
  document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  tool=el.dataset.tool;
  const tipEl=el.querySelector('.tip');
  document.getElementById('stTool').textContent = tipEl ? tipEl.textContent.replace(/\s*\(.\)/,'') : tool;
  const cursors={pencil:'crosshair',brush:'crosshair',eraser:'cell',fill:'cell',eyedropper:'crosshair',select:'default',line:'crosshair',rect:'crosshair',ellipse:'crosshair',text:'text',move:'move',spray:'crosshair'};
  drawCanvas.style.cursor=cursors[tool]||'crosshair';
}
function setFilled(val) {
  filled=val;
  document.getElementById('filledBtn').classList.toggle('active',val);
  document.getElementById('strokeOnlyBtn').classList.toggle('active',!val);
}
function updateSize(el) { brushSize=+el.value; document.getElementById('vSize').textContent=el.value; }
function updateOpacity(el) { opacity=el.value/100; document.getElementById('vOpacity').textContent=el.value; }
function updateHardness(el) { hardness=el.value/100; document.getElementById('vHardness').textContent=el.value; }
function updateSpacing(el) { spacing=+el.value; document.getElementById('vSpacing').textContent=el.value; }
function setFgColor(v) {
  fgColor=v;
  document.getElementById('fgSwatch').style.background=v;
  document.getElementById('fgHex').textContent=v;
  document.getElementById('fgPicker').value=v;
}
function setBgColor(v) {
  bgColor=v;
  document.getElementById('bgSwatch2').style.background=v;
  document.getElementById('bgHex').textContent=v;
  document.getElementById('bgPicker').value=v;
}

// ================================================================
// PALETTE
// ================================================================
const PALETTE=['#000000','#404040','#808080','#bfbfbf','#ffffff','#ff0000','#ff6600','#ffff00','#00ff00','#00ffff','#0000ff','#ff00ff','#800000','#804000','#808000','#008000','#008080','#000080','#ff8080','#ffc080','#ffff80','#80ff80','#80ffff','#8080ff','#c00000','#c06000','#c0c000','#00c000','#00c0c0','#0000c0'];
function buildPalette() {
  const pal=document.getElementById('palette');
  PALETTE.forEach(c=>{
    const div=document.createElement('div');
    div.className='pal-color'; div.style.background=c; div.title=c;
    div.onclick=e=>{ if(e.shiftKey) setBgColor(c); else setFgColor(c); };
    pal.appendChild(div);
  });
}

// ================================================================
// MENUS
// ================================================================
function toggleMenu(btnId,ddId) {
  const isOpen=document.getElementById(ddId).classList.contains('show');
  closeAllMenus();
  if(!isOpen){ document.getElementById(ddId).classList.add('show'); document.getElementById(btnId).classList.add('open'); }
}
function closeAllMenus() {
  document.querySelectorAll('.dropdown').forEach(d=>d.classList.remove('show'));
  document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('open'));
}

// ================================================================
// FILE ‚Äî NEW / OPEN IMAGE
// ================================================================
function newCanvas() { closeAllMenus(); document.getElementById('newName').value=projectName; openModal('newModal'); }
function confirmNew() {
  const w=+document.getElementById('newW').value||800;
  const h=+document.getElementById('newH').value||600;
  const bg=document.getElementById('newBg').value;
  const name=document.getElementById('newName').value.trim()||'untitled';
  initCanvas(w,h,bg,name); updateTitleDisplay(); closeModal('newModal');
}
function openImage() { closeAllMenus(); document.getElementById('fileInput').click(); }
function loadImage(e) {
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      saveState();
      const ctx=activeLayerCtx();
      ctx.drawImage(img,0,0,baseCanvas.width,baseCanvas.height);
      compositeAll();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

// ================================================================
// EXPORT
// ================================================================
function exportCanvas(fmt) {
  closeAllMenus();
  const mime=fmt==='jpg'?'image/jpeg':fmt==='webp'?'image/webp':'image/png';
  const temp=document.createElement('canvas');
  temp.width=baseCanvas.width; temp.height=baseCanvas.height;
  const tctx=temp.getContext('2d');
  if(fmt==='jpg'){tctx.fillStyle='#fff';tctx.fillRect(0,0,temp.width,temp.height);}
  layers.forEach(l=>{if(l.visible)tctx.drawImage(l.canvas,0,0);});
  const link=document.createElement('a');
  link.download=`${projectName}.${fmt}`;
  link.href=temp.toDataURL(mime,0.92);
  link.click();
  showToast(`Exported as ${projectName}.${fmt}`);
}

// ================================================================
// .LYKO PROJECT FORMAT
// Format: JSON with base64 layer data
// {
//   version: "1.0",
//   projectName: string,
//   canvasWidth: number,
//   canvasHeight: number,
//   layers: [{ name, visible, data: base64png }]
// }
// ================================================================
function saveLyko() {
  closeAllMenus();
  const layerData = layers.map(l => ({
    name: l.name,
    visible: l.visible,
    data: l.canvas.toDataURL('image/png')
  }));
  const project = {
    version: '1.0',
    projectName: projectName,
    canvasWidth: baseCanvas.width,
    canvasHeight: baseCanvas.height,
    layers: layerData
  };
  const json = JSON.stringify(project);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.download = `${projectName}.lyko`;
  link.href = url;
  link.click();
  URL.revokeObjectURL(url);
  setDirty(false);
  showToast(`Saved ${projectName}.lyko`);
}

function openLyko() {
  closeAllMenus();
  document.getElementById('lykoInput').click();
}

function loadLyko(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const project = JSON.parse(ev.target.result);
      if (!project.version || !project.layers) throw new Error('Invalid .lyko file');

      const w = project.canvasWidth || 800;
      const h = project.canvasHeight || 600;
      const pname = project.projectName || 'imported';

      // Resize canvases
      baseCanvas.width = w; baseCanvas.height = h;
      drawCanvas.width = w; drawCanvas.height = h;
      document.getElementById('stSize').textContent = `${w} √ó ${h}`;
      document.getElementById('resW').value = w;
      document.getElementById('resH').value = h;

      // Load layers
      const loadedLayers = project.layers;
      let remaining = loadedLayers.length;
      const builtLayers = new Array(loadedLayers.length);

      loadedLayers.forEach((ld, idx) => {
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0);
          builtLayers[idx] = { name: ld.name, canvas: c, visible: ld.visible !== false };
          remaining--;
          if (remaining === 0) {
            layers = builtLayers;
            activeLayerIdx = 0;
            undoStack = []; redoStack = [];
            projectName = pname;
            compositeAll();
            updateLayerUI();
            updateTitleDisplay();
            setDirty(false);
            showToast(`Opened ${pname}.lyko`);
          }
        };
        img.onerror = () => {
          // blank layer fallback
          builtLayers[idx] = { name: ld.name, canvas: c, visible: ld.visible !== false };
          remaining--;
          if (remaining === 0) {
            layers = builtLayers;
            activeLayerIdx = 0;
            projectName = pname;
            compositeAll(); updateLayerUI(); updateTitleDisplay(); setDirty(false);
          }
        };
        img.src = ld.data;
      });

    } catch (err) {
      alert('Failed to open .lyko file:\n' + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ================================================================
// RENAME PROJECT
// ================================================================
function renameProject() {
  closeAllMenus();
  document.getElementById('renameInput').value = projectName;
  openModal('renameModal');
  setTimeout(() => { document.getElementById('renameInput').select(); }, 50);
}
function confirmRename() {
  const name = document.getElementById('renameInput').value.trim();
  if (!name) return;
  // Sanitize: strip invalid filename chars
  projectName = name.replace(/[/\\:*?"<>|]/g,'_');
  updateTitleDisplay();
  setDirty(true);
  closeModal('renameModal');
}

// ================================================================
// EDIT
// ================================================================
function clearCanvas() {
  closeAllMenus();
  if (!confirm('Clear current layer?')) return;
  saveState();
  activeLayerCtx().clearRect(0,0,baseCanvas.width,baseCanvas.height);
  compositeAll();
}

// ================================================================
// IMAGE OPS
// ================================================================
function resizeModal() { closeAllMenus(); openModal('resizeModalEl'); }
function confirmResize() {
  const w=+document.getElementById('resW').value||800;
  const h=+document.getElementById('resH').value||600;
  saveState();
  layers.forEach(l=>{
    const tmp=document.createElement('canvas');
    tmp.width=w;tmp.height=h;
    tmp.getContext('2d').drawImage(l.canvas,0,0,w,h);
    l.canvas=tmp;
  });
  baseCanvas.width=w;baseCanvas.height=h;
  drawCanvas.width=w;drawCanvas.height=h;
  compositeAll();
  document.getElementById('stSize').textContent=`${w} √ó ${h}`;
  closeModal('resizeModalEl');
}
function flipH() {
  closeAllMenus(); saveState();
  layers.forEach(l=>{
    const tmp=document.createElement('canvas');
    tmp.width=l.canvas.width;tmp.height=l.canvas.height;
    tmp.getContext('2d').drawImage(l.canvas,0,0);
    const ctx=l.canvas.getContext('2d');
    ctx.clearRect(0,0,l.canvas.width,l.canvas.height);
    ctx.save();ctx.translate(l.canvas.width,0);ctx.scale(-1,1);
    ctx.drawImage(tmp,0,0);ctx.restore();
  });
  compositeAll();
}
function flipV() {
  closeAllMenus(); saveState();
  layers.forEach(l=>{
    const tmp=document.createElement('canvas');
    tmp.width=l.canvas.width;tmp.height=l.canvas.height;
    tmp.getContext('2d').drawImage(l.canvas,0,0);
    const ctx=l.canvas.getContext('2d');
    ctx.clearRect(0,0,l.canvas.width,l.canvas.height);
    ctx.save();ctx.translate(0,l.canvas.height);ctx.scale(1,-1);
    ctx.drawImage(tmp,0,0);ctx.restore();
  });
  compositeAll();
}
function rotate90() {
  closeAllMenus(); saveState();
  const w=baseCanvas.width,h=baseCanvas.height;
  layers.forEach(l=>{
    const tmp=document.createElement('canvas');
    tmp.width=h;tmp.height=w;
    const tctx=tmp.getContext('2d');
    tctx.translate(h,0);tctx.rotate(Math.PI/2);
    tctx.drawImage(l.canvas,0,0);
    l.canvas=tmp;
  });
  baseCanvas.width=h;baseCanvas.height=w;
  drawCanvas.width=h;drawCanvas.height=w;
  compositeAll();
  document.getElementById('stSize').textContent=`${h} √ó ${w}`;
}
function invertColors() {
  closeAllMenus(); saveState();
  const ctx=activeLayerCtx(), cv=layers[activeLayerIdx].canvas;
  const id=ctx.getImageData(0,0,cv.width,cv.height), d=id.data;
  for(let i=0;i<d.length;i+=4){d[i]=255-d[i];d[i+1]=255-d[i+1];d[i+2]=255-d[i+2];}
  ctx.putImageData(id,0,0); compositeAll();
}
function grayscale() {
  closeAllMenus(); saveState();
  const ctx=activeLayerCtx(), cv=layers[activeLayerIdx].canvas;
  const id=ctx.getImageData(0,0,cv.width,cv.height), d=id.data;
  for(let i=0;i<d.length;i+=4){const g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];d[i]=d[i+1]=d[i+2]=g;}
  ctx.putImageData(id,0,0); compositeAll();
}

// ================================================================
// ZOOM / GRID
// ================================================================
function zoom(factor,absolute) {
  closeAllMenus();
  if(absolute!=null) currentZoom=absolute;
  else currentZoom=Math.min(16,Math.max(0.1,currentZoom*factor));
  const wrapper=document.getElementById('canvasWrapper');
  wrapper.style.transform=`scale(${currentZoom})`;
  wrapper.style.transformOrigin='top left';
  document.getElementById('stZoom').textContent=`${Math.round(currentZoom*100)}%`;
}
function toggleGrid() {
  closeAllMenus();
  gridVisible=!gridVisible;
  const area=document.getElementById('canvasArea');
  area.style.backgroundImage=gridVisible
    ?'linear-gradient(rgba(255,255,255,.07) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.07) 1px,transparent 1px),linear-gradient(45deg,#333 25%,transparent 25%),linear-gradient(-45deg,#333 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#333 75%),linear-gradient(-45deg,transparent 75%,#333 75%)'
    :'linear-gradient(45deg,#333 25%,transparent 25%),linear-gradient(-45deg,#333 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#333 75%),linear-gradient(-45deg,transparent 75%,#333 75%)';
}

// ================================================================
// KEYBOARD
// ================================================================
function onKey(e) {
  const tag=document.activeElement.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA') return;
  if((e.ctrlKey||e.metaKey)){
    if(e.key==='z'){e.preventDefault();undo();}
    if(e.key==='y'){e.preventDefault();redo();}
    if(e.key==='n'){e.preventDefault();newCanvas();}
    if(e.key==='o'){e.preventDefault();openLyko();}
    if(e.key==='s'){e.preventDefault();saveLyko();}
    if(e.key==='='){e.preventDefault();zoom(1.25);}
    if(e.key==='-'){e.preventDefault();zoom(0.8);}
    if(e.key==='0'){e.preventDefault();zoom(null,1);}
    return;
  }
  const sc={p:'pencil',b:'brush',e:'eraser',f:'fill',i:'eyedropper',l:'line',r:'rect',o:'ellipse',t:'text',s:'spray'};
  if(sc[e.key]){const btn=document.querySelector(`[data-tool="${sc[e.key]}"]`);if(btn)setTool(btn);}
}

// ================================================================
// MODALS / TOAST / ABOUT
// ================================================================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showAbout() {
  closeAllMenus();
  alert('Lykos Paint v1.0\n\nA browser-based paint editor.\nSupports .lyko project files with full layer preservation.\n\nBuilt with vanilla JS + Canvas API.');
}
let toastTimer;
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

// ================================================================
// UTILS
// ================================================================
function hexToRgba(hex,a){const[r,g,b]=hexToRgbArr(hex);return `rgba(${r},${g},${b},${a})`;}
function hexToRgbArr(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');return[parseInt(hex.slice(0,2),16),parseInt(hex.slice(2,4),16),parseInt(hex.slice(4,6),16)];}
function rgbToHex(r,g,b){return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
</script>
</body>
</html>