<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyko Lake - Home</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
            background:radial-gradient(ellipse at bottom,#1a3d2e 0%,#0d2818 50%,#06140f 100%);
            color:#e0f2e9;min-height:100vh;
            background-attachment:fixed;
        }
        .hidden{display:none!important}
        nav{
            background:rgba(13,40,24,.85);backdrop-filter:blur(10px);
            padding:20px 40px;display:flex;justify-content:space-between;align-items:center;
            position:sticky;top:0;z-index:1000;
            box-shadow:0 4px 20px rgba(0,0,0,.4);
            border-bottom:2px solid rgba(88,166,100,.4);
        }
        .logo{font-size:1.8em;font-weight:bold;color:#88d8a3;text-decoration:none;display:flex;align-items:center;gap:10px;transition:transform .3s ease}
        .logo:hover{transform:scale(1.05)}
        .nav-center{flex:1;display:flex;justify-content:center;max-width:500px;margin:0 20px}
        .search-bar{width:100%;display:flex;gap:10px;background:rgba(13,40,24,.5);border:2px solid rgba(88,166,100,.4);border-radius:10px;padding:8px 15px}
        .search-bar input{flex:1;background:none;border:none;color:#e0f2e9;font-size:1em;outline:none}
        .search-bar input::placeholder{color:rgba(224,242,233,.5)}
        .search-results{position:absolute;top:100%;left:0;right:0;background:rgba(13,40,24,.98);border:2px solid rgba(88,166,100,.4);border-radius:10px;margin-top:5px;max-height:300px;overflow-y:auto;display:none;z-index:1001}
        .search-results.show{display:block}
        .search-result-item{padding:12px 15px;cursor:pointer;border-bottom:1px solid rgba(88,166,100,.2);display:flex;align-items:center;gap:10px}
        .search-result-item:hover{background:rgba(88,166,100,.2)}
        .search-result-item img{width:40px;height:40px;border-radius:50%;object-fit:cover}
        .nav-right{display:flex;gap:15px;align-items:center}
        .notification-bell{position:relative;background:rgba(88,166,100,.2);border:2px solid #88d8a3;color:#e0f2e9;padding:10px;border-radius:50%;cursor:pointer;font-size:1.2em;transition:all .3s}
        .notification-bell:hover{background:rgba(88,166,100,.3)}
        .notification-badge{position:absolute;top:-5px;right:-5px;background:#ff6b6b;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7em;font-weight:bold}
        .notification-bell.has-new{animation:wiggle 0.5s ease-in-out infinite}
        .auth-button{background:rgba(88,166,100,.2);border:2px solid #88d8a3;color:#e0f2e9;padding:10px 30px;font-size:1em;border-radius:8px;text-decoration:none;font-weight:600;transition:all .3s ease}
        .auth-button:hover{background:#88d8a3;color:#0d2818;transform:translateY(-2px);box-shadow:0 5px 15px rgba(88,166,100,.4)}
        .upload-button{background:rgba(138,201,149,.2);border:2px solid #8ac995;color:#e0f2e9;padding:10px 30px;font-size:1em;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s ease}
        .upload-button:hover{background:#8ac995;color:#0d2818;transform:translateY(-2px)}
        .admin-button{background:rgba(255,107,107,.2);border:2px solid #ff6b6b;color:#e0f2e9;padding:10px 30px;font-size:1em;border-radius:8px;text-decoration:none;font-weight:600;transition:all .3s ease}
        .admin-button:hover{background:#ff6b6b;color:#fff;transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,107,107,.4)}
        .user-menu{position:relative}
        .user-button{background:rgba(88,166,100,.2);border:2px solid #88d8a3;color:#e0f2e9;padding:10px 20px;font-size:1em;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:10px;transition:all .3s ease}
        .user-button:hover{background:rgba(88,166,100,.3);transform:translateY(-2px)}
        .user-avatar{width:30px;height:30px;border-radius:50%;background:radial-gradient(circle,#88d8a3 0%,#5a9e6f 100%);display:flex;align-items:center;justify-content:center;font-size:1.2em;overflow:hidden}
        .user-avatar img{width:100%;height:100%;object-fit:cover}
        .dropdown{position:absolute;top:calc(100% + 10px);right:0;background:rgba(13,40,24,.98);border:2px solid rgba(88,166,100,.4);border-radius:12px;min-width:200px;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all .3s ease;box-shadow:0 10px 30px rgba(0,0,0,.5);backdrop-filter:blur(10px)}
        .dropdown.show{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-item{padding:15px 20px;color:rgba(224,242,233,.9);text-decoration:none;display:flex;align-items:center;gap:12px;cursor:pointer;border-bottom:1px solid rgba(88,166,100,.2)}
        .dropdown-item:last-child{border-bottom:none}
        .dropdown-item:hover{background:rgba(88,166,100,.2);color:#88d8a3}
        .dropdown-item.logout{color:#ff6b6b}
        .dropdown-item.logout:hover{background:rgba(255,107,107,.2)}
        .page-container{max-width:1200px;margin:0 auto;padding:60px 40px;min-height:calc(100vh - 80px)}
        .welcome-section{text-align:center;padding:60px 20px}
        .welcome-title{font-size:4em;margin-bottom:20px;background:linear-gradient(135deg,#88d8a3 0%,#5a9e6f 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .welcome-subtitle{font-size:1.5em;color:rgba(224,242,233,.8);margin-bottom:20px;line-height:1.6}
        .feed-container{max-width:600px;margin:40px auto}
        .post-carousel{position:relative;background:rgba(13,40,24,.5);border:2px solid rgba(88,166,100,.4);border-radius:15px;padding:30px;backdrop-filter:blur(10px);min-height:400px}
        .carousel-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .carousel-button{background:rgba(88,166,100,.2);border:2px solid #88d8a3;color:#88d8a3;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s}
        .carousel-button:hover:not(:disabled){background:#88d8a3;color:#0d2818}
        .carousel-button:disabled{opacity:.3;cursor:not-allowed}
        .post-card{display:none}
        .post-card.active{display:block}
        .post-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .post-avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;cursor:pointer}
        .post-author{flex:1;cursor:pointer}
        .post-author-name{font-size:1.2em;font-weight:600;margin-bottom:3px}
        .post-author-username{color:rgba(224,242,233,.6);font-size:.9em}
        .post-date{color:rgba(224,242,233,.5);font-size:.8em}
        .follow-button{background:rgba(88,166,100,.2);border:2px solid #88d8a3;color:#88d8a3;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:.9em;font-weight:600;transition:all .3s}
        .follow-button:hover{background:#88d8a3;color:#0d2818}
        .follow-button.following{background:#5a9e6f;border-color:#5a9e6f;color:#e0f2e9}
        .post-content{margin:20px 0;cursor:pointer}
        .post-text{color:rgba(224,242,233,.9);line-height:1.6;margin-bottom:15px;white-space:pre-wrap;word-wrap:break-word}
        .post-media{width:100%;max-height:400px;border-radius:10px;margin-bottom:15px;overflow:hidden}
        .post-media img,.post-media video{width:100%;max-height:400px;object-fit:contain;border-radius:10px}
        .post-stats{display:flex;gap:20px;margin-bottom:15px;color:rgba(224,242,233,.6)}
        .post-actions{display:flex;gap:20px;padding-top:15px;border-top:1px solid rgba(88,166,100,.2)}
        .action-button{background:none;border:none;color:rgba(224,242,233,.7);cursor:pointer;display:flex;align-items:center;gap:8px;font-size:1.1em;transition:all .3s;padding:8px 12px;border-radius:6px}
        .action-button:hover{background:rgba(88,166,100,.1)}
        .action-button.liked{color:#ff6b6b}
        .action-button.disliked{color:#8b7355}
        .comments-section{margin-top:20px;border-top:2px solid rgba(88,166,100,.2);padding-top:20px}
        .comments-toggle{color:#88d8a3;cursor:pointer;font-weight:600;margin-bottom:15px;display:inline-block}
        .comments-toggle:hover{text-decoration:underline}
        .comments-list{display:none;margin-bottom:15px}
        .comments-list.show{display:block}
        .comment-item{background:rgba(13,40,24,.3);border-left:3px solid rgba(88,166,100,.4);padding:12px;margin-bottom:10px;border-radius:5px}
        .comment-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
        .comment-avatar{width:30px;height:30px;border-radius:50%;object-fit:cover}
        .comment-author{font-weight:600;font-size:.9em}
        .comment-text{color:rgba(224,242,233,.8);line-height:1.5;font-size:.95em}
        .comment-input-container{display:flex;gap:10px;margin-top:15px}
        .comment-input{flex:1;background:rgba(13,40,24,.3);border:2px solid rgba(88,166,100,.4);border-radius:8px;padding:10px;color:#e0f2e9;font-size:.95em;resize:none;min-height:40px}
        .comment-input:focus{outline:none;border-color:#88d8a3}
        .comment-submit{background:rgba(88,166,100,.2);border:2px solid #88d8a3;color:#88d8a3;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s}
        .comment-submit:hover{background:#88d8a3;color:#0d2818}
        .no-posts{text-align:center;padding:60px 20px;color:rgba(224,242,233,.6);font-size:1.2em}
        .loading{text-align:center;padding:40px;color:rgba(224,242,233,.6)}
        .notification-dropdown{position:absolute;top:calc(100% + 10px);right:0;background:rgba(13,40,24,.98);border:2px solid rgba(88,166,100,.4);border-radius:12px;min-width:300px;max-width:400px;max-height:500px;overflow-y:auto;display:none;z-index:1002;backdrop-filter:blur(10px)}
        .notification-dropdown.show{display:block}
        .notification-item{padding:15px;border-bottom:1px solid rgba(88,166,100,.2);cursor:pointer;transition:background .3s}
        .notification-item:hover{background:rgba(88,166,100,.1)}
        .notification-item.unread{background:rgba(88,166,100,.2)}
        .notification-time{font-size:.8em;color:rgba(224,242,233,.6);margin-top:5px}
        .notification-empty{padding:30px;text-align:center;color:rgba(224,242,233,.5)}
        .hover-card{position:fixed;background:rgba(13,40,24,.98);border:2px solid rgba(88,166,100,.4);border-radius:12px;padding:15px;min-width:200px;max-width:300px;z-index:1003;display:none;backdrop-filter:blur(10px);pointer-events:none}
        .hover-card-avatar{width:60px;height:60px;border-radius:50%;margin-bottom:10px;object-fit:cover}
        .hover-card-name{font-weight:600;margin-bottom:5px}
        .hover-card-username{color:rgba(224,242,233,.6);margin-bottom:5px}
        .hover-card-rank{font-size:.8em;padding:2px 8px;border-radius:10px;margin-bottom:5px;display:inline-block}
        .hover-card-date{font-size:.8em;color:rgba(224,242,233,.6)}
        .post-modal-overlay{position:fixed;inset:0;background:rgba(6,20,15,.9);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(5px)}
        .post-modal{background:rgba(13,40,24,.95);border:2px solid rgba(88,166,100,.4);border-radius:20px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 15px 50px rgba(0,0,0,.5);backdrop-filter:blur(10px)}
        .post-modal-close{position:absolute;top:15px;right:15px;background:none;border:none;color:rgba(224,242,233,.7);font-size:1.5em;cursor:pointer;transition:color .3s}
        .post-modal-close:hover{color:#88d8a3}
        .version-footer{position:fixed;bottom:10px;left:10px;color:rgba(224,242,233,0.5);font-size:0.8em;z-index:1000;pointer-events:none}
        @keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        @keyframes wiggle{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
        @media(max-width:768px){nav{padding:20px;flex-wrap:wrap}.nav-center{order:3;width:100%;margin-top:15px}.welcome-title{font-size:2.5em}}
    </style>
</head>
<body>
    <nav>
        <a href="/" class="logo">üåä Lyko Lake</a>
        <div class="nav-center hidden" id="navSearch">
            <div class="search-bar" style="position:relative">
                <input type="text" id="searchInput" placeholder="Search users...">
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        <div class="nav-right">
            <button class="notification-bell hidden" id="notificationBell">üîî<span class="notification-badge hidden" id="notificationBadge">0</span></button>
            <div class="notification-dropdown hidden" id="notificationDropdown"></div>
            <button class="upload-button hidden" id="uploadButton">Upload</button>
            <a href="/auth.html" class="auth-button" id="authButton">Sign Up / Login</a>
            <a href="/admin.html" class="admin-button hidden" id="adminButton">Admin</a>
            <div class="user-menu hidden" id="userMenu">
                <button class="user-button" id="userButton">
                    <div class="user-avatar" id="navUserAvatar"><img id="navAvatarImg" src="" alt="Avatar" style="display:none"></div>
                    <span id="userDisplayName">Loading...</span>
                </button>
                <div class="dropdown" id="dropdown">
                    <a class="dropdown-item" id="profileLink"><span>üë§</span><span>Profile</span></a>
                    <a href="/help.html" class="dropdown-item"><span>‚ùì</span><span>Help</span></a>
                    <div class="dropdown-item logout" id="logoutButton"><span>üö™</span><span>Log Out</span></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <div class="welcome-section">
            <h1 class="welcome-title">Welcome to Lyko Lake</h1>
            <p class="welcome-subtitle">An open creative space for adults.</p>
            <p style="color:rgba(224,242,233,.7);max-width:700px;margin:20px auto;line-height:1.6">
                Lyko Lake is an open creative space. We allow strong language and adult topics 
                <strong>as long as they respect others and remain legal</strong>. 
                Content that promotes hate, violence, or non-consensual sexual material is removed.
            </p>
        </div>
        <div class="feed-container hidden" id="feedContainer">
            <div class="post-carousel">
                <div class="carousel-controls">
                    <button class="carousel-button" id="prevButton" disabled>‚Üê Previous</button>
                    <span id="postCounter" style="color:rgba(224,242,233,.7)">0 / 0</span>
                    <button class="carousel-button" id="nextButton" disabled>Next ‚Üí</button>
                </div>
                <div id="postsContainer"><div class="loading">Loading posts...</div></div>
            </div>
        </div>
    </div>

    <div class="hover-card hidden" id="hoverCard">
        <img class="hover-card-avatar" id="hoverAvatar" src="" alt="">
        <div class="hover-card-name" id="hoverName"></div>
        <div class="hover-card-username" id="hoverUsername"></div>
        <div class="hover-card-rank hidden" id="hoverRank"></div>
        <div class="hover-card-date" id="hoverDate"></div>
    </div>

    <div class="post-modal-overlay hidden" id="postModalOverlay">
        <div class="post-modal">
            <button class="post-modal-close" id="postModalClose">&times;</button>
            <div id="postModalContent"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs, query, limit, orderBy, setDoc, deleteDoc, where, addDoc, serverTimestamp, updateDoc, increment, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDUBeWvs6kOijqST6FVGirWs2EZ12aAAwU",
            authDomain: "lyko-lake.firebaseapp.com",
            projectId: "lyko-lake",
            storageBucket: "lyko-lake.firebasestorage.app",
            messagingSenderId: "685592614306",
            appId: "1:685592614306:web:b6a8f6f18407f9c0154efb"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentPosts = [], currentPostIndex = 0, viewedPosts = new Set();

        /* ---------- nav / auth ---------- */
        const authButton = document.getElementById('authButton');
        const adminButton = document.getElementById('adminButton');
        const uploadButton = document.getElementById('uploadButton');
        const userMenu = document.getElementById('userMenu');
        const userButton = document.getElementById('userButton');
        const dropdown = document.getElementById('dropdown');
        const userDisplayName = document.getElementById('userDisplayName');
        const profileLink = document.getElementById('profileLink');
        const logoutButton = document.getElementById('logoutButton');
        const navUserAvatar = document.getElementById('navUserAvatar');
        const navAvatarImg = document.getElementById('navAvatarImg');
        const feedContainer = document.getElementById('feedContainer');
        const notificationBell = document.getElementById('notificationBell');
        const notificationBadge = document.getElementById('notificationBadge');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const navSearch = document.getElementById('navSearch');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const hoverCard = document.getElementById('hoverCard');
        const postModalOverlay = document.getElementById('postModalOverlay');
        const postModalClose = document.getElementById('postModalClose');

        userButton.addEventListener('click', e => { e.stopPropagation(); dropdown.classList.toggle('show'); });
        document.addEventListener('click', () => dropdown.classList.remove('show'));
        logoutButton.addEventListener('click', async () => { await signOut(auth); window.location.reload(); });
        uploadButton.addEventListener('click', () => { window.location.href = '/upload'; });
        postModalClose.addEventListener('click', () => postModalOverlay.classList.add('hidden'));
        postModalOverlay.addEventListener('click', e => { if (e.target === postModalOverlay) postModalOverlay.classList.add('hidden'); });

        /* ---------- search ---------- */
        let searchTimeout;
        searchInput.addEventListener('input', async () => {
            clearTimeout(searchTimeout);
            const queryText = searchInput.value.trim().toLowerCase();
            if (queryText.length < 2) { searchResults.classList.remove('show'); return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const usersSnap = await getDocs(collection(db, 'users'));
                    const matches = [];
                    usersSnap.forEach(doc => {
                        const user = doc.data();
                        if (user.username.toLowerCase().includes(queryText) || user.displayName.toLowerCase().includes(queryText)) matches.push(user);
                    });
                    searchResults.innerHTML = '';
                    if (matches.length === 0) searchResults.innerHTML = '<div style="padding:15px;color:rgba(224,242,233,.5)">No users found</div>';
                    else {
                        matches.slice(0, 5).forEach(user => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `
                                <img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="${user.displayName}">
                                <div>
                                    <div style="font-weight:600">${user.displayName}</div>
                                    <div style="font-size:.9em;color:rgba(224,242,233,.6)">@${user.username}</div>
                                </div>
                            `;
                            item.addEventListener('click', () => { window.location.href = `/${user.username}`; });
                            searchResults.appendChild(item);
                        });
                    }
                    searchResults.classList.add('show');
                } catch (error) { console.error('Search error:', error); }
            }, 300);
        });
        document.addEventListener('click', e => { if (!searchResults.contains(e.target) && e.target !== searchInput) searchResults.classList.remove('show'); });

        /* ---------- notifications ---------- */
        notificationBell.addEventListener('click', async () => {
            notificationDropdown.classList.toggle('show');
            if (notificationDropdown.classList.contains('show')) await loadNotifications();
        });
        document.addEventListener('click', e => { if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) notificationDropdown.classList.remove('show'); });

        async function loadNotifications() {
            if (!currentUser) return;
            try {
                const notifSnap = await getDocs(query(collection(db, 'notifications'), where('userId', '==', currentUser.userId), orderBy('createdAt', 'desc'), limit(20)));
                notificationDropdown.innerHTML = '';
                if (notifSnap.empty) { notificationDropdown.innerHTML = '<div class="notification-empty">Follow More People To Get More Updates</div>'; return; }
                let unreadCount = 0;
                notifSnap.forEach(doc => {
                    const notif = doc.data();
                    if (!notif.read) unreadCount++;
                    const item = document.createElement('div');
                    item.className = `notification-item ${notif.read ? '' : 'unread'}`;
                    item.innerHTML = `<div>${notif.message}</div><div class="notification-time">${notif.createdAt?.toDate().toLocaleString() || 'Unknown time'}</div>`;
                    item.addEventListener('click', async () => {
                        if (!notif.read) await updateDoc(doc.ref, { read: true });
                        if (notif.postId) await openPostModal(notif.postId);
                        else if (notif.link) window.location.href = notif.link;
                        notificationDropdown.classList.remove('show');
                    });
                    notificationDropdown.appendChild(item);
                });
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                    notificationBell.classList.add('has-new');
                } else {
                    notificationBadge.classList.add('hidden');
                    notificationBell.classList.remove('has-new');
                }
            } catch (error) {
                console.error('loadNotifications error:', error);
                notificationDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:#ff6b6b">Error loading notifications</div>';
            }
        }

        /* ---------- hover card ---------- */
        let hoverTimeout, currentHoverElement = null;
        function setupHoverCard(element, userData) {
            element.addEventListener('mouseenter', e => {
                currentHoverElement = element;
                clearTimeout(hoverTimeout);
                hoverTimeout = setTimeout(async () => {
                    if (!userData.rank && userData.userId) {
                        const userSnap = await getDoc(doc(db, 'users', userData.userId));
                        if (userSnap.exists()) userData = { ...userData, ...userSnap.data() };
                    }
                    showHoverCard(e, userData);
                }, 500);
            });
            element.addEventListener('mouseleave', () => {
                clearTimeout(hoverTimeout);
                if (!hoverCard.contains(document.elementFromPoint(event.clientX, event.clientY))) hideHoverCard();
            });
        }
        function showHoverCard(e, userData) {
            const hoverAvatar = document.getElementById('hoverAvatar');
            const hoverName = document.getElementById('hoverName');
            const hoverUsername = document.getElementById('hoverUsername');
            const hoverRank = document.getElementById('hoverRank');
            const hoverDate = document.getElementById('hoverDate');
            if (userData.avatar) {
                hoverAvatar.src = userData.avatar;
                hoverAvatar.style.display = 'block';
            } else {
                hoverAvatar.style.display = 'none';
            }
            hoverName.textContent = userData.displayName;
            hoverUsername.textContent = `@${userData.username} | User #${userData.uid || 'N/A'}`;
            if (userData.rank) {
                hoverRank.textContent = userData.rank;
                hoverRank.className = `hover-card-rank ${userData.rank.toLowerCase()}`;
                hoverRank.style.background = userData.rank === 'CEO' ? '#ff6b6b' : '#88d8a3';
                hoverRank.style.color = '#fff';
                hoverRank.classList.remove('hidden');
            } else {
                hoverRank.classList.add('hidden');
            }
            hoverDate.textContent = userData.createdAt ? `Joined ${userData.createdAt.toDate().toLocaleDateString()}` : '';
            hoverCard.style.left = e.clientX + 10 + 'px';
            hoverCard.style.top = e.clientY + 10 + 'px';
            hoverCard.classList.remove('hidden');
        }
        function hideHoverCard() {
            hoverCard.classList.add('hidden');
        }
        document.addEventListener('mousemove', e => {
            if (hoverCard.classList.contains('show')) {
                const rect = hoverCard.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
                    if (!currentHoverElement?.contains(e.target)) hideHoverCard();
                }
            }
        });

        /* ---------- post modal ---------- */
        async function openPostModal(postId) {
            try {
                const postSnap = await getDoc(doc(db, 'posts', postId));
                if (!postSnap.exists()) return;
                const post = postSnap.data();
                const authorSnap = await getDoc(doc(db, 'users', post.authorId));
                const author = authorSnap.exists() ? authorSnap.data() : { displayName: 'Unknown', username: 'unknown' };

                let mediaHtml = '';
                if (post.mediaUrl) {
                    mediaHtml = post.mediaType === 'video'
                        ? `<div class="post-media"><video controls src="${post.mediaUrl}"></video></div>`
                        : `<div class="post-media"><img src="${post.mediaUrl}" alt="Post media"></div>`;
                }

                const userLikeStatus = await getUserLikeStatus(post.id);
                const commentCount = await getCommentCount(post.id);

                document.getElementById('postModalContent').innerHTML = `
                    <div class="post-header">
                        <img class="post-avatar" src="${author.avatar || 'https://via.placeholder.com/50'}" alt="${author.displayName}">
                        <div class="post-author">
                            <div class="post-author-name">${author.displayName}</div>
                            <div class="post-author-username">@${author.username}</div>
                        </div>
                    </div>
                    <div class="post-content">
                        ${post.content ? `<div class="post-text">${post.content}</div>` : ''}
                        ${mediaHtml}
                    </div>
                    <div class="post-stats"><span>üëÅÔ∏è ${post.views || 0} views</span></div>
                    <div class="post-actions">
                        <button class="action-button like-button ${userLikeStatus === 'like' ? 'liked' : ''}" data-post-id="${post.id}" data-modal="true">‚ù§Ô∏è <span>${post.likes || 0}</span></button>
                        <button class="action-button dislike-button ${userLikeStatus === 'dislike' ? 'disliked' : ''}" data-post-id="${post.id}" data-modal="true">üí© <span>${post.dislikes || 0}</span></button>
                        <button class="action-button comment-button" data-post-id="${post.id}" data-modal="true">üí¨ <span class="comment-count">${commentCount}</span></button>
                    </div>
                    <div class="comments-section">
                        <div class="comments-toggle" data-post-id="${post.id}" data-modal="true">Show Comments</div>
                        <div class="comments-list" id="modal-comments-${post.id}"></div>
                        <div class="comment-input-container">
                            <textarea class="comment-input" placeholder="Add a comment..." data-post-id="${post.id}" data-modal="true"></textarea>
                            <button class="comment-submit" data-post-id="${post.id}" data-modal="true">Post</button>
                        </div>
                    </div>
                `;
                postModalOverlay.classList.remove('hidden');
                attachModalPostActions();
            } catch (error) {
                console.error('openPostModal error:', error);
            }
        }

        function attachModalPostActions() {
            document.querySelectorAll('.post-modal .like-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    await handleLike(postId, 'like', btn);
                    await openPostModal(postId);
                });
            });
            document.querySelectorAll('.post-modal .dislike-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    await handleLike(postId, 'dislike', btn);
                    await openPostModal(postId);
                });
            });
            document.querySelectorAll('.post-modal .comments-toggle').forEach(toggle => {
                toggle.addEventListener('click', async () => {
                    const postId = toggle.dataset.postId;
                    const list = document.getElementById(`modal-comments-${postId}`);
                    if (list.classList.contains('show')) {
                        list.classList.remove('show');
                        toggle.textContent = 'Show Comments';
                    } else {
                        await loadModalComments(postId);
                        list.classList.add('show');
                        toggle.textContent = 'Hide Comments';
                    }
                });
            });
            document.querySelectorAll('.post-modal .comment-submit').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    const input = document.querySelector(`.post-modal .comment-input[data-post-id="${postId}"]`);
                    const text = input.value.trim();
                    if (!text) return;
                    try {
                        await addDoc(collection(db, 'comments'), { postId, authorId: currentUser.userId, text, createdAt: serverTimestamp() });
                        input.value = '';
                        await loadModalComments(postId);
                        const countSpan = document.querySelector(`.post-modal .comment-button[data-post-id="${postId}"] .comment-count`);
                        if (countSpan) countSpan.textContent = parseInt(countSpan.textContent) + 1;
                    } catch (error) {
                        console.error('comment submit error:', error);
                    }
                });
            });
        }

        async function loadModalComments(postId) {
            const list = document.getElementById(`modal-comments-${postId}`);
            try {
                const snap = await getDocs(query(collection(db, 'comments'), where('postId', '==', postId), orderBy('createdAt', 'desc')));
                if (snap.empty) {
                    list.innerHTML = '<div style="color:rgba(224,242,233,.5);padding:10px">No comments yet</div>';
                    return;
                }
                list.innerHTML = '';
                for (const docSnap of snap.docs) {
                    const c = docSnap.data();
                    const authorSnap = await getDoc(doc(db, 'users', c.authorId));
                    const author = authorSnap.exists() ? authorSnap.data() : { displayName: 'Unknown', avatar: '' };
                    const item = document.createElement('div');
                    item.className = 'comment-item';
                    item.innerHTML = `
                        <div class="comment-header">
                            <img class="comment-avatar" src="${author.avatar || 'https://via.placeholder.com/30'}" alt="${author.displayName}">
                            <span class="comment-author">${author.displayName}</span>
                        </div>
                        <div class="comment-text">${c.text}</div>
                    `;
                    list.appendChild(item);
                }
            } catch (error) {
                console.error('loadModalComments error:', error);
                list.innerHTML = '<div style="color:#ff6b6b;padding:10px">Error loading comments</div>';
            }
        }

        async function getUserLikeStatus(postId) {
            if (!currentUser) return null;
            const snap = await getDocs(query(collection(db, 'likes'), where('userId', '==', currentUser.userId), where('postId', '==', postId)));
            return snap.empty ? null : snap.docs[0].data().type;
        }

        async function getCommentCount(postId) {
            const snap = await getDocs(query(collection(db, 'comments'), where('postId', '==', postId)));
            return snap.size;
        }

        async function handleLike(postId, type, button) {
            try {
                const likeSnap = await getDocs(query(collection(db, 'likes'), where('userId', '==', currentUser.userId), where('postId', '==', postId)));
                const postRef = doc(db, 'posts', postId);
                const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                const likeBtn = postCard.querySelector('.like-button');
                const dislikeBtn = postCard.querySelector('.dislike-button');

                if (!likeSnap.empty) {
                    const existing = likeSnap.docs[0];
                    const existingType = existing.data().type;
                    if (existingType === type) {
                        await deleteDoc(existing.ref);
                        await updateDoc(postRef, { [type === 'like' ? 'likes' : 'dislikes']: increment(-1) });
                        button.classList.remove(type === 'like' ? 'liked' : 'disliked');
                        const count = parseInt(button.querySelector('span').textContent);
                        button.querySelector('span').textContent = count - 1;
                    } else {
                        await deleteDoc(existing.ref);
                        await addDoc(collection(db, 'likes'), { userId: currentUser.userId, postId, type, createdAt: serverTimestamp() });
                        await updateDoc(postRef, {
                            [existingType === 'like' ? 'likes' : 'dislikes']: increment(-1),
                            [type === 'like' ? 'likes' : 'dislikes']: increment(1)
                        });
                        if (type === 'like') {
                            likeBtn.classList.add('liked'); dislikeBtn.classList.remove('disliked');
                            likeBtn.querySelector('span').textContent = parseInt(likeBtn.querySelector('span').textContent) + 1;
                            dislikeBtn.querySelector('span').textContent = parseInt(dislikeBtn.querySelector('span').textContent) - 1;
                        } else {
                            dislikeBtn.classList.add('disliked'); likeBtn.classList.remove('liked');
                            dislikeBtn.querySelector('span').textContent = parseInt(dislikeBtn.querySelector('span').textContent) + 1;
                            likeBtn.querySelector('span').textContent = parseInt(likeBtn.querySelector('span').textContent) - 1;
                        }
                    }
                } else {
                    await addDoc(collection(db, 'likes'), { userId: currentUser.userId, postId, type, createdAt: serverTimestamp() });
                    await updateDoc(postRef, { [type === 'like' ? 'likes' : 'dislikes']: increment(1) });
                    button.classList.add(type === 'like' ? 'liked' : 'disliked');
                    const count = parseInt(button.querySelector('span').textContent);
                    button.querySelector('span').textContent = count + 1;
                }
            } catch (error) {
                console.error('handleLike error:', error);
            }
        }

        async function loadComments(postId) {
            const list = document.getElementById(`comments-${postId}`);
            try {
                const snap = await getDocs(query(collection(db, 'comments'), where('postId', '==', postId), orderBy('createdAt', 'desc')));
                if (snap.empty) {
                    list.innerHTML = '<div style="color:rgba(224,242,233,.5);padding:10px">No comments yet</div>';
                    return;
                }
                list.innerHTML = '';
                for (const docSnap of snap.docs) {
                    const c = docSnap.data();
                    const authorSnap = await getDoc(doc(db, 'users', c.authorId));
                    const author = authorSnap.exists() ? authorSnap.data() : { displayName: 'Unknown', avatar: '' };
                    const item = document.createElement('div');
                    item.className = 'comment-item';
                    item.innerHTML = `
                        <div class="comment-header">
                            <img class="comment-avatar" src="${author.avatar || 'https://via.placeholder.com/30'}" alt="${author.displayName}">
                            <span class="comment-author">${author.displayName}</span>
                        </div>
                        <div class="comment-text">${c.text}</div>
                    `;
                    list.appendChild(item);
                }
            } catch (error) {
                console.error('loadComments error:', error);
                list.innerHTML = '<div style="color:#ff6b6b;padding:10px">Error loading comments</div>';
            }
        }

        /* ---------- post carousel ---------- */
        function updateCarouselControls() {
            document.getElementById('postCounter').textContent = `${currentPostIndex + 1} / ${currentPosts.length}`;
            document.getElementById('prevButton').disabled = currentPostIndex === 0;
            document.getElementById('nextButton').disabled = currentPostIndex === currentPosts.length - 1;
        }
        document.getElementById('prevButton').addEventListener('click', async () => {
            if (currentPostIndex > 0) {
                document.querySelectorAll('.post-card')[currentPostIndex].classList.remove('active');
                currentPostIndex--;
                document.querySelectorAll('.post-card')[currentPostIndex].classList.add('active');
                updateCarouselControls();
                await trackView(currentPosts[currentPostIndex].id);
            }
        });
        document.getElementById('nextButton').addEventListener('click', async () => {
            if (currentPostIndex < currentPosts.length - 1) {
                document.querySelectorAll('.post-card')[currentPostIndex].classList.remove('active');
                currentPostIndex++;
                document.querySelectorAll('.post-card')[currentPostIndex].classList.add('active');
                updateCarouselControls();
                await trackView(currentPosts[currentPostIndex].id);
            }
        });

        async function trackView(postId) {
            if (!currentUser || viewedPosts.has(postId)) return;
            try {
                const viewDocId = `${currentUser.userId}_${postId}`;
                const viewRef = doc(db, 'postViews', viewDocId);
                const viewSnap = await getDoc(viewRef);
                if (!viewSnap.exists()) {
                    await setDoc(viewRef, { userId: currentUser.userId, postId: postId, viewedAt: serverTimestamp() });
                    await updateDoc(doc(db, 'posts', postId), { views: increment(1) });
                    viewedPosts.add(postId);
                    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
                    if (postCard) {
                        const viewsSpan = postCard.querySelector('.post-stats span');
                        if (viewsSpan) {
                            const currentViews = parseInt(viewsSpan.textContent.match(/\d+/)[0]);
                            viewsSpan.textContent = `üëÅÔ∏è ${currentViews + 1} views`;
                        }
                    }
                }
            } catch (error) {
                console.error('trackView error:', error);
            }
        }

        /* ---------- post loading ---------- */
        async function loadPosts() {
            try {
                const postsSnap = await getDocs(collection(db, 'posts'));
                const allPosts = [];
                postsSnap.forEach(doc => allPosts.push({ id: doc.id, ...doc.data() }));
                currentPosts = allPosts.sort((a, b) => {
                    const dateA = a.createdAt?.toMillis() || 0;
                    const dateB = b.createdAt?.toMillis() || 0;
                    return dateB - dateA;
                }).slice(0, 10);
                if (currentPosts.length === 0) {
                    document.getElementById('postsContainer').innerHTML = '<div class="no-posts">No posts yet. Be the first to upload!</div>';
                    return;
                }
                await renderPosts();
            } catch (error) {
                console.error('loadPosts error:', error);
                document.getElementById('postsContainer').innerHTML = '<div class="no-posts">Error loading posts</div>';
            }
        }

        async function renderPosts() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = '';
            for (let i = 0; i < currentPosts.length; i++) {
                const post = currentPosts[i];
                const authorSnap = await getDoc(doc(db, 'users', post.authorId));
                const author = authorSnap.exists() ? authorSnap.data() : { displayName: 'Unknown', username: 'unknown' };
                const postCard = document.createElement('div');
                postCard.className = `post-card ${i === 0 ? 'active' : ''}`;
                postCard.dataset.postId = post.id;
                let mediaHtml = '';
                if (post.mediaUrl) {
                    mediaHtml = post.mediaType === 'video'
                        ? `<div class="post-media"><video controls src="${post.mediaUrl}"></video></div>`
                        : `<div class="post-media"><img src="${post.mediaUrl}" alt="Post media"></div>`;
                }
                const isFollowing = await checkIfFollowing(post.authorId);
                const followBtnText = isFollowing ? 'Following' : 'Follow';
                const followBtnClass = isFollowing ? 'following' : '';
                const userLikeStatus = await getUserLikeStatus(post.id);
                const commentCount = await getCommentCount(post.id);
                const postDate = post.createdAt?.toDate() || new Date();
                const dateStr = formatPostDate(postDate);
                postCard.innerHTML = `
                    <div class="post-header">
                        <img class="post-avatar" src="${author.avatar || 'https://via.placeholder.com/50'}" alt="${author.displayName}" data-user-id="${post.authorId}">
                        <div class="post-author" data-user-id="${post.authorId}">
                            <div class="post-author-name">${author.displayName}</div>
                            <div class="post-author-username">@${author.username}</div>
                            <div class="post-date">${dateStr}</div>
                        </div>
                        ${post.authorId !== currentUser.userId ? `<button class="follow-button ${followBtnClass}" data-author-id="${post.authorId}">${followBtnText}</button>` : ''}
                    </div>
                    <div class="post-content" data-post-id="${post.id}">
                        ${post.content ? `<div class="post-text">${post.content}</div>` : ''}
                        ${mediaHtml}
                    </div>
                    <div class="post-stats"><span>üëÅÔ∏è ${post.views || 0} views</span></div>
                    <div class="post-actions">
                        <button class="action-button like-button ${userLikeStatus === 'like' ? 'liked' : ''}" data-post-id="${post.id}">‚ù§Ô∏è <span>${post.likes || 0}</span></button>
                        <button class="action-button dislike-button ${userLikeStatus === 'dislike' ? 'disliked' : ''}" data-post-id="${post.id}">üí© <span>${post.dislikes || 0}</span></button>
                        <button class="action-button comment-button" data-post-id="${post.id}">üí¨ <span class="comment-count">${commentCount}</span></button>
                        <button class="action-button report-button" data-post-id="${post.id}">üö© Report</button>
                    </div>
                    <div class="comments-section">
                        <div class="comments-toggle" data-post-id="${post.id}">Show Comments</div>
                        <div class="comments-list" id="comments-${post.id}"></div>
                        <div class="comment-input-container">
                            <textarea class="comment-input" placeholder="Add a comment..." data-post-id="${post.id}"></textarea>
                            <button class="comment-submit" data-post-id="${post.id}">Post</button>
                        </div>
                    </div>
                `;
                container.appendChild(postCard);
                setupHoverCard(postCard.querySelector('.post-avatar'), { ...author, userId: post.authorId });
                setupHoverCard(postCard.querySelector('.post-author'), { ...author, userId: post.authorId });
                postCard.querySelector('.post-content').addEventListener('click', () => openPostModal(post.id));
                if (i === 0) await trackView(post.id);
            }
            updateCarouselControls();
            attachPostActions();
        }

        function formatPostDate(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function attachPostActions() {
            document.querySelectorAll('.follow-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const authorId = btn.dataset.authorId;
                    const isFollowing = btn.classList.contains('following');
                    try {
                        if (isFollowing) {
                            const snap = await getDocs(query(collection(db, 'follows'), where('followerId', '==', currentUser.userId), where('followingId', '==', authorId)));
                            snap.forEach(async d => await deleteDoc(d.ref));
                            btn.classList.remove('following'); btn.textContent = 'Follow';
                        } else {
                            await addDoc(collection(db, 'follows'), { followerId: currentUser.userId, followingId: authorId, createdAt: serverTimestamp() });
                            btn.classList.add('following'); btn.textContent = 'Following';
                        }
                    } catch (error) { console.error('Follow error:', error); }
                });
            });
            document.querySelectorAll('.like-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    await handleLike(postId, 'like', btn);
                });
            });
            document.querySelectorAll('.dislike-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    await handleLike(postId, 'dislike', btn);
                });
            });
            document.querySelectorAll('.comments-toggle').forEach(toggle => {
                toggle.addEventListener('click', async () => {
                    const postId = toggle.dataset.postId;
                    const list = document.getElementById(`comments-${postId}`);
                    if (list.classList.contains('show')) {
                        list.classList.remove('show');
                        toggle.textContent = 'Show Comments';
                    } else {
                        await loadComments(postId);
                        list.classList.add('show');
                        toggle.textContent = 'Hide Comments';
                    }
                });
            });
            document.querySelectorAll('.comment-submit').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                    const text = input.value.trim();
                    if (!text) return;
                    try {
                        await addDoc(collection(db, 'comments'), { postId, authorId: currentUser.userId, text, createdAt: serverTimestamp() });
                        input.value = '';
                        await loadComments(postId);
                        const countSpan = document.querySelector(`.comment-button[data-post-id="${postId}"] .comment-count`);
                        if (countSpan) countSpan.textContent = parseInt(countSpan.textContent) + 1;
                    } catch (error) { console.error('Comment error:', error); }
                });
            });
            document.querySelectorAll('.report-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    const reason = prompt('Please describe why you are reporting this post:');
                    if (reason) {
                        try {
                            await addDoc(collection(db, 'reports'), { postId, reportedBy: currentUser.userId, reason, createdAt: serverTimestamp(), status: 'pending' });
                            alert('Report submitted. Thank you.');
                        } catch (error) {
                            console.error('Report error:', error);
                            alert('Failed to submit report.');
                        }
                    }
                });
            });
        }

        async function checkForNewPosts() {
            if (!currentUser) return;
            try {
                const followingSnap = await getDocs(query(collection(db, 'follows'), where('followerId', '==', currentUser.userId)));
                const followingIds = [];
                followingSnap.forEach(doc => followingIds.push(doc.data().followingId));
                if (followingIds.length === 0) return;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const postsSnap = await getDocs(query(collection(db, 'posts'), where('authorId', 'in', followingIds), where('createdAt', '>', Timestamp.fromDate(yesterday))));
                const newPosts = [];
                postsSnap.forEach(doc => {
                    const notifKey = `notified_${doc.id}`;
                    if (!localStorage.getItem(notifKey)) {
                        newPosts.push({ id: doc.id, ...doc.data() });
                        localStorage.setItem(notifKey, 'true');
                    }
                });
                if (newPosts.length > 0) {
                    for (const post of newPosts) {
                        const authorSnap = await getDoc(doc(db, 'users', post.authorId));
                        const author = authorSnap.data();
                        await addDoc(collection(db, 'notifications'), {
                            userId: currentUser.userId,
                            message: `${author.displayName} posted new content`,
                            postId: post.id,
                            type: 'new_post',
                            read: false,
                            createdAt: serverTimestamp()
                        });
                    }
                    await loadNotificationCount();
                }
            } catch (error) {
                console.error('checkForNewPosts error:', error);
            }
        }

        async function checkForNewComments() {
            if (!currentUser) return;
            try {
                const userPostsSnap = await getDocs(query(collection(db, 'posts'), where('authorId', '==', currentUser.userId)));
                const userPostIds = [];
                userPostsSnap.forEach(doc => userPostIds.push(doc.id));
                if (userPostIds.length === 0) return;
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const commentsSnap = await getDocs(query(collection(db, 'comments'), where('postId', 'in', userPostIds), where('createdAt', '>', Timestamp.fromDate(yesterday))));
                const newComments = [];
                commentsSnap.forEach(doc => {
                    const comment = doc.data();
                    if (comment.authorId !== currentUser.userId) {
                        const notifKey = `comment_notified_${doc.id}`;
                        if (!localStorage.getItem(notifKey)) {
                            newComments.push({ id: doc.id, ...comment });
                            localStorage.setItem(notifKey, 'true');
                        }
                    }
                });
                if (newComments.length > 0) {
                    for (const comment of newComments) {
                        const authorSnap = await getDoc(doc(db, 'users', comment.authorId));
                        const author = authorSnap.data();
                        await addDoc(collection(db, 'notifications'), {
                            userId: currentUser.userId,
                            message: `${author.displayName} commented on your post`,
                            postId: comment.postId,
                            type: 'new_comment',
                            read: false,
                            createdAt: serverTimestamp()
                        });
                    }
                    await loadNotificationCount();
                }
            } catch (error) {
                console.error('checkForNewComments error:', error);
            }
        }

        async function loadNotificationCount() {
            if (!currentUser) return;
            try {
                const snap = await getDocs(query(collection(db, 'notifications'), where('userId', '==', currentUser.userId), where('read', '==', false)));
                const count = snap.size;
                if (count > 0) {
                    notificationBadge.textContent = count;
                    notificationBadge.classList.remove('hidden');
                    notificationBell.classList.add('has-new');
                } else {
                    notificationBadge.classList.add('hidden');
                    notificationBell.classList.remove('has-new');
                }
            } catch (error) {
                console.error('loadNotificationCount error:', error);
            }
        }

        /* ---------- auth state ---------- */
        onAuthStateChanged(auth, async user => {
            if (user && user.emailVerified) {
                const snap = await getDoc(doc(db, 'users', user.uid));
                if (snap.exists()) {
                    currentUser = { ...snap.data(), userId: user.uid };
                    authButton.classList.add('hidden');
                    userMenu.classList.remove('hidden');
                    uploadButton.classList.remove('hidden');
                    notificationBell.classList.remove('hidden');
                    navSearch.classList.remove('hidden');
                    feedContainer.classList.remove('hidden');
                    userDisplayName.textContent = currentUser.displayName;
                    profileLink.href = `/${currentUser.username}`;
                    if (currentUser.avatar) {
                        navAvatarImg.src = currentUser.avatar;
                        navAvatarImg.style.display = 'block';
                    }
                    if (currentUser.rank === 'Admin' || currentUser.rank === 'CEO' || currentUser.customRank) {
                        adminButton.classList.remove('hidden');
                    }
                    await loadNotifications();
                    await loadPosts();
                    await checkForNewPosts();
                    await checkForNewComments();
                }
            } else {
                authButton.classList.remove('hidden');
                adminButton.classList.add('hidden');
                uploadButton.classList.add('hidden');
                notificationBell.classList.add('hidden');
                navSearch.classList.add('hidden');
                userMenu.classList.add('hidden');
                feedContainer.classList.add('hidden');
            }
        });
    </script>
    <div class="version-footer">¬©2025 Lyko Sokolov - Lyko Lake v1.1.0</div>
</body>
</html>
